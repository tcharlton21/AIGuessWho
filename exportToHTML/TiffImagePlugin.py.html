<html>
<head>
<title>TiffImagePlugin.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #a5c261;}
.s5 { color: #6a8759;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
TiffImagePlugin.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># The Python Imaging Library.</span>
<span class="s0"># $Id$</span>
<span class="s0">#</span>
<span class="s0"># TIFF file handling</span>
<span class="s0">#</span>
<span class="s0"># TIFF is a flexible, if somewhat aged, image file format originally</span>
<span class="s0"># defined by Aldus.  Although TIFF supports a wide variety of pixel</span>
<span class="s0"># layouts and compression methods, the name doesn't really stand for</span>
<span class="s0"># &quot;thousands of incompatible file formats,&quot; it just feels that way.</span>
<span class="s0">#</span>
<span class="s0"># To read TIFF data from a stream, the stream must be seekable.  For</span>
<span class="s0"># progressive decoding, make sure to use TIFF files where the tag</span>
<span class="s0"># directory is placed first in the file.</span>
<span class="s0">#</span>
<span class="s0"># History:</span>
<span class="s0"># 1995-09-01 fl   Created</span>
<span class="s0"># 1996-05-04 fl   Handle JPEGTABLES tag</span>
<span class="s0"># 1996-05-18 fl   Fixed COLORMAP support</span>
<span class="s0"># 1997-01-05 fl   Fixed PREDICTOR support</span>
<span class="s0"># 1997-08-27 fl   Added support for rational tags (from Perry Stoll)</span>
<span class="s0"># 1998-01-10 fl   Fixed seek/tell (from Jan Blom)</span>
<span class="s0"># 1998-07-15 fl   Use private names for internal variables</span>
<span class="s0"># 1999-06-13 fl   Rewritten for PIL 1.0 (1.0)</span>
<span class="s0"># 2000-10-11 fl   Additional fixes for Python 2.0 (1.1)</span>
<span class="s0"># 2001-04-17 fl   Fixed rewind support (seek to frame 0) (1.2)</span>
<span class="s0"># 2001-05-12 fl   Added write support for more tags (from Greg Couch) (1.3)</span>
<span class="s0"># 2001-12-18 fl   Added workaround for broken Matrox library</span>
<span class="s0"># 2002-01-18 fl   Don't mess up if photometric tag is missing (D. Alan Stewart)</span>
<span class="s0"># 2003-05-19 fl   Check FILLORDER tag</span>
<span class="s0"># 2003-09-26 fl   Added RGBa support</span>
<span class="s0"># 2004-02-24 fl   Added DPI support; fixed rational write support</span>
<span class="s0"># 2005-02-07 fl   Added workaround for broken Corel Draw 10 files</span>
<span class="s0"># 2006-01-09 fl   Added support for float/double tags (from Russell Nelson)</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 1997-2006 by Secret Labs AB.  All rights reserved.</span>
<span class="s0"># Copyright (c) 1995-1997 by Fredrik Lundh</span>
<span class="s0">#</span>
<span class="s0"># See the README file for information on usage and redistribution.</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">struct</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">collections.abc </span><span class="s2">import </span><span class="s1">MutableMapping</span>
<span class="s2">from </span><span class="s1">fractions </span><span class="s2">import </span><span class="s1">Fraction</span>
<span class="s2">from </span><span class="s1">numbers </span><span class="s2">import </span><span class="s1">Number</span><span class="s2">, </span><span class="s1">Rational</span>

<span class="s2">from </span><span class="s1">. </span><span class="s2">import </span><span class="s1">Image</span><span class="s2">, </span><span class="s1">ImageFile</span><span class="s2">, </span><span class="s1">ImageOps</span><span class="s2">, </span><span class="s1">ImagePalette</span><span class="s2">, </span><span class="s1">TiffTags</span>
<span class="s2">from </span><span class="s1">._binary </span><span class="s2">import </span><span class="s1">i16be </span><span class="s2">as </span><span class="s1">i16</span>
<span class="s2">from </span><span class="s1">._binary </span><span class="s2">import </span><span class="s1">i32be </span><span class="s2">as </span><span class="s1">i32</span>
<span class="s2">from </span><span class="s1">._binary </span><span class="s2">import </span><span class="s1">o8</span>
<span class="s2">from </span><span class="s1">.TiffTags </span><span class="s2">import </span><span class="s1">TYPES</span>

<span class="s1">logger = logging.getLogger(__name__)</span>

<span class="s0"># Set these to true to force use of libtiff for reading or writing.</span>
<span class="s1">READ_LIBTIFF = </span><span class="s2">False</span>
<span class="s1">WRITE_LIBTIFF = </span><span class="s2">False</span>
<span class="s1">IFD_LEGACY_API = </span><span class="s2">True</span>
<span class="s1">STRIP_SIZE = </span><span class="s3">65536</span>

<span class="s1">II = </span><span class="s4">b&quot;II&quot;  </span><span class="s0"># little-endian (Intel style)</span>
<span class="s1">MM = </span><span class="s4">b&quot;MM&quot;  </span><span class="s0"># big-endian (Motorola style)</span>

<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Read TIFF files</span>

<span class="s0"># a few tag names, just to make the code below a bit more readable</span>
<span class="s1">IMAGEWIDTH = </span><span class="s3">256</span>
<span class="s1">IMAGELENGTH = </span><span class="s3">257</span>
<span class="s1">BITSPERSAMPLE = </span><span class="s3">258</span>
<span class="s1">COMPRESSION = </span><span class="s3">259</span>
<span class="s1">PHOTOMETRIC_INTERPRETATION = </span><span class="s3">262</span>
<span class="s1">FILLORDER = </span><span class="s3">266</span>
<span class="s1">IMAGEDESCRIPTION = </span><span class="s3">270</span>
<span class="s1">STRIPOFFSETS = </span><span class="s3">273</span>
<span class="s1">SAMPLESPERPIXEL = </span><span class="s3">277</span>
<span class="s1">ROWSPERSTRIP = </span><span class="s3">278</span>
<span class="s1">STRIPBYTECOUNTS = </span><span class="s3">279</span>
<span class="s1">X_RESOLUTION = </span><span class="s3">282</span>
<span class="s1">Y_RESOLUTION = </span><span class="s3">283</span>
<span class="s1">PLANAR_CONFIGURATION = </span><span class="s3">284</span>
<span class="s1">RESOLUTION_UNIT = </span><span class="s3">296</span>
<span class="s1">TRANSFERFUNCTION = </span><span class="s3">301</span>
<span class="s1">SOFTWARE = </span><span class="s3">305</span>
<span class="s1">DATE_TIME = </span><span class="s3">306</span>
<span class="s1">ARTIST = </span><span class="s3">315</span>
<span class="s1">PREDICTOR = </span><span class="s3">317</span>
<span class="s1">COLORMAP = </span><span class="s3">320</span>
<span class="s1">TILEWIDTH = </span><span class="s3">322</span>
<span class="s1">TILELENGTH = </span><span class="s3">323</span>
<span class="s1">TILEOFFSETS = </span><span class="s3">324</span>
<span class="s1">TILEBYTECOUNTS = </span><span class="s3">325</span>
<span class="s1">SUBIFD = </span><span class="s3">330</span>
<span class="s1">EXTRASAMPLES = </span><span class="s3">338</span>
<span class="s1">SAMPLEFORMAT = </span><span class="s3">339</span>
<span class="s1">JPEGTABLES = </span><span class="s3">347</span>
<span class="s1">YCBCRSUBSAMPLING = </span><span class="s3">530</span>
<span class="s1">REFERENCEBLACKWHITE = </span><span class="s3">532</span>
<span class="s1">COPYRIGHT = </span><span class="s3">33432</span>
<span class="s1">IPTC_NAA_CHUNK = </span><span class="s3">33723  </span><span class="s0"># newsphoto properties</span>
<span class="s1">PHOTOSHOP_CHUNK = </span><span class="s3">34377  </span><span class="s0"># photoshop properties</span>
<span class="s1">ICCPROFILE = </span><span class="s3">34675</span>
<span class="s1">EXIFIFD = </span><span class="s3">34665</span>
<span class="s1">XMP = </span><span class="s3">700</span>
<span class="s1">JPEGQUALITY = </span><span class="s3">65537  </span><span class="s0"># pseudo-tag by libtiff</span>

<span class="s0"># https://github.com/imagej/ImageJA/blob/master/src/main/java/ij/io/TiffDecoder.java</span>
<span class="s1">IMAGEJ_META_DATA_BYTE_COUNTS = </span><span class="s3">50838</span>
<span class="s1">IMAGEJ_META_DATA = </span><span class="s3">50839</span>

<span class="s1">COMPRESSION_INFO = {</span>
    <span class="s0"># Compression =&gt; pil compression name</span>
    <span class="s3">1</span><span class="s1">: </span><span class="s5">&quot;raw&quot;</span><span class="s2">,</span>
    <span class="s3">2</span><span class="s1">: </span><span class="s5">&quot;tiff_ccitt&quot;</span><span class="s2">,</span>
    <span class="s3">3</span><span class="s1">: </span><span class="s5">&quot;group3&quot;</span><span class="s2">,</span>
    <span class="s3">4</span><span class="s1">: </span><span class="s5">&quot;group4&quot;</span><span class="s2">,</span>
    <span class="s3">5</span><span class="s1">: </span><span class="s5">&quot;tiff_lzw&quot;</span><span class="s2">,</span>
    <span class="s3">6</span><span class="s1">: </span><span class="s5">&quot;tiff_jpeg&quot;</span><span class="s2">,  </span><span class="s0"># obsolete</span>
    <span class="s3">7</span><span class="s1">: </span><span class="s5">&quot;jpeg&quot;</span><span class="s2">,</span>
    <span class="s3">8</span><span class="s1">: </span><span class="s5">&quot;tiff_adobe_deflate&quot;</span><span class="s2">,</span>
    <span class="s3">32771</span><span class="s1">: </span><span class="s5">&quot;tiff_raw_16&quot;</span><span class="s2">,  </span><span class="s0"># 16-bit padding</span>
    <span class="s3">32773</span><span class="s1">: </span><span class="s5">&quot;packbits&quot;</span><span class="s2">,</span>
    <span class="s3">32809</span><span class="s1">: </span><span class="s5">&quot;tiff_thunderscan&quot;</span><span class="s2">,</span>
    <span class="s3">32946</span><span class="s1">: </span><span class="s5">&quot;tiff_deflate&quot;</span><span class="s2">,</span>
    <span class="s3">34676</span><span class="s1">: </span><span class="s5">&quot;tiff_sgilog&quot;</span><span class="s2">,</span>
    <span class="s3">34677</span><span class="s1">: </span><span class="s5">&quot;tiff_sgilog24&quot;</span><span class="s2">,</span>
    <span class="s3">34925</span><span class="s1">: </span><span class="s5">&quot;lzma&quot;</span><span class="s2">,</span>
    <span class="s3">50000</span><span class="s1">: </span><span class="s5">&quot;zstd&quot;</span><span class="s2">,</span>
    <span class="s3">50001</span><span class="s1">: </span><span class="s5">&quot;webp&quot;</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">COMPRESSION_INFO_REV = {v: k </span><span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">COMPRESSION_INFO.items()}</span>

<span class="s1">OPEN_INFO = {</span>
    <span class="s0"># (ByteOrder, PhotoInterpretation, SampleFormat, FillOrder, BitsPerSample,</span>
    <span class="s0">#  ExtraSamples) =&gt; mode, rawmode</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;1;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;2R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;4R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;I&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;IR&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;L;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">12</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I;16&quot;</span><span class="s2">, </span><span class="s5">&quot;I;12&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I;16&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I;16&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I;16B&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I;16&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16S&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16BS&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">3</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;F&quot;</span><span class="s2">, </span><span class="s5">&quot;F;32F&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">(</span><span class="s3">3</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;F&quot;</span><span class="s2">, </span><span class="s5">&quot;F;32BF&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I&quot;</span><span class="s2">, </span><span class="s5">&quot;I;32N&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I&quot;</span><span class="s2">, </span><span class="s5">&quot;I;32S&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;I&quot;</span><span class="s2">, </span><span class="s5">&quot;I;32BS&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">3</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;F&quot;</span><span class="s2">, </span><span class="s5">&quot;F;32F&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">3</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;F&quot;</span><span class="s2">, </span><span class="s5">&quot;F;32BF&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;LA&quot;</span><span class="s2">, </span><span class="s5">&quot;LA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;LA&quot;</span><span class="s2">, </span><span class="s5">&quot;LA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s0"># missing ExtraSamples</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s0"># missing ExtraSamples</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBXXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBXXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBa&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBa&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBaX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBaX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBaXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBaXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBAX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBAX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBAXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBAXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">999</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s0"># Corel Draw 10</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">999</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s0"># Corel Draw 10</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBa;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBa;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBA;16B&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;1&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;1&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;1R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;1R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;2&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;2&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;2R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;2R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;4&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;4&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;4R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">4</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;4R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;PA&quot;</span><span class="s2">, </span><span class="s5">&quot;PA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">2</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;PA&quot;</span><span class="s2">, </span><span class="s5">&quot;PA&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;P;R&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYK&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYK&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYKX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">,</span><span class="s1">)): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYKX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYKXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYKXX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s5">&quot;CMYK;16L&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s0"># JPEG compressed images handled by LibTiff and auto-converted to RGBX</span>
    <span class="s0"># Minimal Baseline TIFF requires YCbCr images to have 3 SamplesPerPixel</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGBX&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(II</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;LAB&quot;</span><span class="s2">, </span><span class="s5">&quot;LAB&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">(MM</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s1">()): (</span><span class="s5">&quot;LAB&quot;</span><span class="s2">, </span><span class="s5">&quot;LAB&quot;</span><span class="s1">)</span><span class="s2">,</span>
<span class="s1">}</span>

<span class="s1">MAX_SAMPLESPERPIXEL = max(len(key_tp[</span><span class="s3">4</span><span class="s1">]) </span><span class="s2">for </span><span class="s1">key_tp </span><span class="s2">in </span><span class="s1">OPEN_INFO.keys())</span>

<span class="s1">PREFIXES = [</span>
    <span class="s4">b&quot;MM</span><span class="s2">\x00\x2A</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># Valid TIFF header with big-endian byte order</span>
    <span class="s4">b&quot;II</span><span class="s2">\x2A\x00</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># Valid TIFF header with little-endian byte order</span>
    <span class="s4">b&quot;MM</span><span class="s2">\x2A\x00</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># Invalid TIFF header, assume big-endian</span>
    <span class="s4">b&quot;II</span><span class="s2">\x00\x2A</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># Invalid TIFF header, assume little-endian</span>
    <span class="s4">b&quot;MM</span><span class="s2">\x00\x2B</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># BigTIFF with big-endian byte order</span>
    <span class="s4">b&quot;II</span><span class="s2">\x2B\x00</span><span class="s4">&quot;</span><span class="s2">,  </span><span class="s0"># BigTIFF with little-endian byte order</span>
<span class="s1">]</span>


<span class="s2">def </span><span class="s1">_accept(prefix):</span>
    <span class="s2">return </span><span class="s1">prefix[:</span><span class="s3">4</span><span class="s1">] </span><span class="s2">in </span><span class="s1">PREFIXES</span>


<span class="s2">def </span><span class="s1">_limit_rational(val</span><span class="s2">, </span><span class="s1">max_val):</span>
    <span class="s1">inv = abs(val) &gt; </span><span class="s3">1</span>
    <span class="s1">n_d = IFDRational(</span><span class="s3">1 </span><span class="s1">/ val </span><span class="s2">if </span><span class="s1">inv </span><span class="s2">else </span><span class="s1">val).limit_rational(max_val)</span>
    <span class="s2">return </span><span class="s1">n_d[::-</span><span class="s3">1</span><span class="s1">] </span><span class="s2">if </span><span class="s1">inv </span><span class="s2">else </span><span class="s1">n_d</span>


<span class="s2">def </span><span class="s1">_limit_signed_rational(val</span><span class="s2">, </span><span class="s1">max_val</span><span class="s2">, </span><span class="s1">min_val):</span>
    <span class="s1">frac = Fraction(val)</span>
    <span class="s1">n_d = frac.numerator</span><span class="s2">, </span><span class="s1">frac.denominator</span>

    <span class="s2">if </span><span class="s1">min(n_d) &lt; min_val:</span>
        <span class="s1">n_d = _limit_rational(val</span><span class="s2">, </span><span class="s1">abs(min_val))</span>

    <span class="s2">if </span><span class="s1">max(n_d) &gt; max_val:</span>
        <span class="s1">val = Fraction(*n_d)</span>
        <span class="s1">n_d = _limit_rational(val</span><span class="s2">, </span><span class="s1">max_val)</span>

    <span class="s2">return </span><span class="s1">n_d</span>


<span class="s0">##</span>
<span class="s0"># Wrapper for TIFF IFDs.</span>

<span class="s1">_load_dispatch = {}</span>
<span class="s1">_write_dispatch = {}</span>


<span class="s2">class </span><span class="s1">IFDRational(Rational):</span>
    <span class="s6">&quot;&quot;&quot;Implements a rational class where 0/0 is a legal value to match 
    the in the wild use of exif rationals. 
 
    e.g., DigitalZoomRatio - 0.00/0.00  indicates that no digital zoom was used 
    &quot;&quot;&quot;</span>

    <span class="s5">&quot;&quot;&quot; If the denominator is 0, store this as a float('nan'), otherwise store 
    as a fractions.Fraction(). Delegate as appropriate 
 
    &quot;&quot;&quot;</span>

    <span class="s1">__slots__ = (</span><span class="s5">&quot;_numerator&quot;</span><span class="s2">, </span><span class="s5">&quot;_denominator&quot;</span><span class="s2">, </span><span class="s5">&quot;_val&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">denominator=</span><span class="s3">1</span><span class="s1">):</span>
        <span class="s6">&quot;&quot;&quot; 
        :param value: either an integer numerator, a 
        float/rational/other number, or an IFDRational 
        :param denominator: Optional integer denominator 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">IFDRational):</span>
            <span class="s1">self._numerator = value.numerator</span>
            <span class="s1">self._denominator = value.denominator</span>
            <span class="s1">self._val = value._val</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">Fraction):</span>
            <span class="s1">self._numerator = value.numerator</span>
            <span class="s1">self._denominator = value.denominator</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">self._numerator = value</span>
            <span class="s1">self._denominator = denominator</span>

        <span class="s2">if </span><span class="s1">denominator == </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s1">self._val = float(</span><span class="s5">&quot;nan&quot;</span><span class="s1">)</span>
        <span class="s2">elif </span><span class="s1">denominator == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">self._val = Fraction(value)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">self._val = Fraction(value</span><span class="s2">, </span><span class="s1">denominator)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">numerator(self):</span>
        <span class="s2">return </span><span class="s1">self._numerator</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">denominator(self):</span>
        <span class="s2">return </span><span class="s1">self._denominator</span>

    <span class="s2">def </span><span class="s1">limit_rational(self</span><span class="s2">, </span><span class="s1">max_denominator):</span>
        <span class="s6">&quot;&quot;&quot; 
 
        :param max_denominator: Integer, the maximum denominator value 
        :returns: Tuple of (numerator, denominator) 
        &quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">self.denominator == </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">self.numerator</span><span class="s2">, </span><span class="s1">self.denominator</span>

        <span class="s1">f = self._val.limit_denominator(max_denominator)</span>
        <span class="s2">return </span><span class="s1">f.numerator</span><span class="s2">, </span><span class="s1">f.denominator</span>

    <span class="s2">def </span><span class="s1">__repr__(self):</span>
        <span class="s2">return </span><span class="s1">str(float(self._val))</span>

    <span class="s2">def </span><span class="s1">__hash__(self):</span>
        <span class="s2">return </span><span class="s1">self._val.__hash__()</span>

    <span class="s2">def </span><span class="s1">__eq__(self</span><span class="s2">, </span><span class="s1">other):</span>
        <span class="s1">val = self._val</span>
        <span class="s2">if </span><span class="s1">isinstance(other</span><span class="s2">, </span><span class="s1">IFDRational):</span>
            <span class="s1">other = other._val</span>
        <span class="s2">if </span><span class="s1">isinstance(other</span><span class="s2">, </span><span class="s1">float):</span>
            <span class="s1">val = float(val)</span>
        <span class="s2">return </span><span class="s1">val == other</span>

    <span class="s2">def </span><span class="s1">__getstate__(self):</span>
        <span class="s2">return </span><span class="s1">[self._val</span><span class="s2">, </span><span class="s1">self._numerator</span><span class="s2">, </span><span class="s1">self._denominator]</span>

    <span class="s2">def </span><span class="s1">__setstate__(self</span><span class="s2">, </span><span class="s1">state):</span>
        <span class="s1">IFDRational.__init__(self</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">_val</span><span class="s2">, </span><span class="s1">_numerator</span><span class="s2">, </span><span class="s1">_denominator = state</span>
        <span class="s1">self._val = _val</span>
        <span class="s1">self._numerator = _numerator</span>
        <span class="s1">self._denominator = _denominator</span>

    <span class="s2">def </span><span class="s1">_delegate(op):</span>
        <span class="s2">def </span><span class="s1">delegate(self</span><span class="s2">, </span><span class="s1">*args):</span>
            <span class="s2">return </span><span class="s1">getattr(self._val</span><span class="s2">, </span><span class="s1">op)(*args)</span>

        <span class="s2">return </span><span class="s1">delegate</span>

    <span class="s5">&quot;&quot;&quot; a = ['add','radd', 'sub', 'rsub', 'mul', 'rmul', 
             'truediv', 'rtruediv', 'floordiv', 'rfloordiv', 
             'mod','rmod', 'pow','rpow', 'pos', 'neg', 
             'abs', 'trunc', 'lt', 'gt', 'le', 'ge', 'bool', 
             'ceil', 'floor', 'round'] 
        print(&quot;</span><span class="s2">\n</span><span class="s5">&quot;.join(&quot;__%s__ = _delegate('__%s__')&quot; % (s,s) for s in a)) 
        &quot;&quot;&quot;</span>

    <span class="s1">__add__ = _delegate(</span><span class="s5">&quot;__add__&quot;</span><span class="s1">)</span>
    <span class="s1">__radd__ = _delegate(</span><span class="s5">&quot;__radd__&quot;</span><span class="s1">)</span>
    <span class="s1">__sub__ = _delegate(</span><span class="s5">&quot;__sub__&quot;</span><span class="s1">)</span>
    <span class="s1">__rsub__ = _delegate(</span><span class="s5">&quot;__rsub__&quot;</span><span class="s1">)</span>
    <span class="s1">__mul__ = _delegate(</span><span class="s5">&quot;__mul__&quot;</span><span class="s1">)</span>
    <span class="s1">__rmul__ = _delegate(</span><span class="s5">&quot;__rmul__&quot;</span><span class="s1">)</span>
    <span class="s1">__truediv__ = _delegate(</span><span class="s5">&quot;__truediv__&quot;</span><span class="s1">)</span>
    <span class="s1">__rtruediv__ = _delegate(</span><span class="s5">&quot;__rtruediv__&quot;</span><span class="s1">)</span>
    <span class="s1">__floordiv__ = _delegate(</span><span class="s5">&quot;__floordiv__&quot;</span><span class="s1">)</span>
    <span class="s1">__rfloordiv__ = _delegate(</span><span class="s5">&quot;__rfloordiv__&quot;</span><span class="s1">)</span>
    <span class="s1">__mod__ = _delegate(</span><span class="s5">&quot;__mod__&quot;</span><span class="s1">)</span>
    <span class="s1">__rmod__ = _delegate(</span><span class="s5">&quot;__rmod__&quot;</span><span class="s1">)</span>
    <span class="s1">__pow__ = _delegate(</span><span class="s5">&quot;__pow__&quot;</span><span class="s1">)</span>
    <span class="s1">__rpow__ = _delegate(</span><span class="s5">&quot;__rpow__&quot;</span><span class="s1">)</span>
    <span class="s1">__pos__ = _delegate(</span><span class="s5">&quot;__pos__&quot;</span><span class="s1">)</span>
    <span class="s1">__neg__ = _delegate(</span><span class="s5">&quot;__neg__&quot;</span><span class="s1">)</span>
    <span class="s1">__abs__ = _delegate(</span><span class="s5">&quot;__abs__&quot;</span><span class="s1">)</span>
    <span class="s1">__trunc__ = _delegate(</span><span class="s5">&quot;__trunc__&quot;</span><span class="s1">)</span>
    <span class="s1">__lt__ = _delegate(</span><span class="s5">&quot;__lt__&quot;</span><span class="s1">)</span>
    <span class="s1">__gt__ = _delegate(</span><span class="s5">&quot;__gt__&quot;</span><span class="s1">)</span>
    <span class="s1">__le__ = _delegate(</span><span class="s5">&quot;__le__&quot;</span><span class="s1">)</span>
    <span class="s1">__ge__ = _delegate(</span><span class="s5">&quot;__ge__&quot;</span><span class="s1">)</span>
    <span class="s1">__bool__ = _delegate(</span><span class="s5">&quot;__bool__&quot;</span><span class="s1">)</span>
    <span class="s1">__ceil__ = _delegate(</span><span class="s5">&quot;__ceil__&quot;</span><span class="s1">)</span>
    <span class="s1">__floor__ = _delegate(</span><span class="s5">&quot;__floor__&quot;</span><span class="s1">)</span>
    <span class="s1">__round__ = _delegate(</span><span class="s5">&quot;__round__&quot;</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">ImageFileDirectory_v2(MutableMapping):</span>
    <span class="s6">&quot;&quot;&quot;This class represents a TIFF tag directory.  To speed things up, we 
    don't decode tags unless they're asked for. 
 
    Exposes a dictionary interface of the tags in the directory:: 
 
        ifd = ImageFileDirectory_v2() 
        ifd[key] = 'Some Data' 
        ifd.tagtype[key] = TiffTags.ASCII 
        print(ifd[key]) 
        'Some Data' 
 
    Individual values are returned as the strings or numbers, sequences are 
    returned as tuples of the values. 
 
    The tiff metadata type of each item is stored in a dictionary of 
    tag types in 
    :attr:`~PIL.TiffImagePlugin.ImageFileDirectory_v2.tagtype`. The types 
    are read from a tiff file, guessed from the type added, or added 
    manually. 
 
    Data Structures: 
 
        * ``self.tagtype = {}`` 
 
          * Key: numerical TIFF tag number 
          * Value: integer corresponding to the data type from 
            :py:data:`.TiffTags.TYPES` 
 
          .. versionadded:: 3.0.0 
 
    'Internal' data structures: 
 
        * ``self._tags_v2 = {}`` 
 
          * Key: numerical TIFF tag number 
          * Value: decoded data, as tuple for multiple values 
 
        * ``self._tagdata = {}`` 
 
          * Key: numerical TIFF tag number 
          * Value: undecoded byte string from file 
 
        * ``self._tags_v1 = {}`` 
 
          * Key: numerical TIFF tag number 
          * Value: decoded data in the v1 format 
 
    Tags will be found in the private attributes ``self._tagdata``, and in 
    ``self._tags_v2`` once decoded. 
 
    ``self.legacy_api`` is a value for internal use, and shouldn't be changed 
    from outside code. In cooperation with 
    :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v1`, if ``legacy_api`` 
    is true, then decoded tags will be populated into both ``_tags_v1`` and 
    ``_tags_v2``. ``_tags_v2`` will be used if this IFD is used in the TIFF 
    save routine. Tags should be read from ``_tags_v1`` if 
    ``legacy_api == true``. 
 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">ifh=</span><span class="s4">b&quot;II</span><span class="s2">\052\0\0\0\0\0</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s1">prefix=</span><span class="s2">None, </span><span class="s1">group=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s6">&quot;&quot;&quot;Initialize an ImageFileDirectory. 
 
        To construct an ImageFileDirectory from a real file, pass the 8-byte 
        magic header to the constructor.  To only set the endianness, pass it 
        as the 'prefix' keyword argument. 
 
        :param ifh: One of the accepted magic headers (cf. PREFIXES); also sets 
              endianness. 
        :param prefix: Override the endianness of the file. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">_accept(ifh):</span>
            <span class="s1">msg = </span><span class="s5">f&quot;not a TIFF file (header </span><span class="s2">{</span><span class="s1">repr(ifh)</span><span class="s2">} </span><span class="s5">not valid)&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg)</span>
        <span class="s1">self._prefix = prefix </span><span class="s2">if </span><span class="s1">prefix </span><span class="s2">is not None else </span><span class="s1">ifh[:</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s2">if </span><span class="s1">self._prefix == MM:</span>
            <span class="s1">self._endian = </span><span class="s5">&quot;&gt;&quot;</span>
        <span class="s2">elif </span><span class="s1">self._prefix == II:</span>
            <span class="s1">self._endian = </span><span class="s5">&quot;&lt;&quot;</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">&quot;not a TIFF IFD&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg)</span>
        <span class="s1">self._bigtiff = ifh[</span><span class="s3">2</span><span class="s1">] == </span><span class="s3">43</span>
        <span class="s1">self.group = group</span>
        <span class="s1">self.tagtype = {}</span>
        <span class="s5">&quot;&quot;&quot; Dictionary of tag types &quot;&quot;&quot;</span>
        <span class="s1">self.reset()</span>
        <span class="s1">(self.next</span><span class="s2">,</span><span class="s1">) = (</span>
            <span class="s1">self._unpack(</span><span class="s5">&quot;Q&quot;</span><span class="s2">, </span><span class="s1">ifh[</span><span class="s3">8</span><span class="s1">:]) </span><span class="s2">if </span><span class="s1">self._bigtiff </span><span class="s2">else </span><span class="s1">self._unpack(</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">ifh[</span><span class="s3">4</span><span class="s1">:])</span>
        <span class="s1">)</span>
        <span class="s1">self._legacy_api = </span><span class="s2">False</span>

    <span class="s1">prefix = property(</span><span class="s2">lambda </span><span class="s1">self: self._prefix)</span>
    <span class="s1">offset = property(</span><span class="s2">lambda </span><span class="s1">self: self._offset)</span>
    <span class="s1">legacy_api = property(</span><span class="s2">lambda </span><span class="s1">self: self._legacy_api)</span>

    <span class="s1">@legacy_api.setter</span>
    <span class="s2">def </span><span class="s1">legacy_api(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">msg = </span><span class="s5">&quot;Not allowing setting of legacy api&quot;</span>
        <span class="s2">raise </span><span class="s1">Exception(msg)</span>

    <span class="s2">def </span><span class="s1">reset(self):</span>
        <span class="s1">self._tags_v1 = {}  </span><span class="s0"># will remain empty if legacy_api is false</span>
        <span class="s1">self._tags_v2 = {}  </span><span class="s0"># main tag storage</span>
        <span class="s1">self._tagdata = {}</span>
        <span class="s1">self.tagtype = {}  </span><span class="s0"># added 2008-06-05 by Florian Hoech</span>
        <span class="s1">self._next = </span><span class="s2">None</span>
        <span class="s1">self._offset = </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">__str__(self):</span>
        <span class="s2">return </span><span class="s1">str(dict(self))</span>

    <span class="s2">def </span><span class="s1">named(self):</span>
        <span class="s6">&quot;&quot;&quot; 
        :returns: dict of name|key: value 
 
        Returns the complete tag dictionary, with named tags where possible. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">{</span>
            <span class="s1">TiffTags.lookup(code</span><span class="s2">, </span><span class="s1">self.group).name: value</span>
            <span class="s2">for </span><span class="s1">code</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">self.items()</span>
        <span class="s1">}</span>

    <span class="s2">def </span><span class="s1">__len__(self):</span>
        <span class="s2">return </span><span class="s1">len(set(self._tagdata) | set(self._tags_v2))</span>

    <span class="s2">def </span><span class="s1">__getitem__(self</span><span class="s2">, </span><span class="s1">tag):</span>
        <span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">self._tags_v2:  </span><span class="s0"># unpack on the fly</span>
            <span class="s1">data = self._tagdata[tag]</span>
            <span class="s1">typ = self.tagtype[tag]</span>
            <span class="s1">size</span><span class="s2">, </span><span class="s1">handler = self._load_dispatch[typ]</span>
            <span class="s1">self[tag] = handler(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">self.legacy_api)  </span><span class="s0"># check type</span>
        <span class="s1">val = self._tags_v2[tag]</span>
        <span class="s2">if </span><span class="s1">self.legacy_api </span><span class="s2">and not </span><span class="s1">isinstance(val</span><span class="s2">, </span><span class="s1">(tuple</span><span class="s2">, </span><span class="s1">bytes)):</span>
            <span class="s1">val = (val</span><span class="s2">,</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">val</span>

    <span class="s2">def </span><span class="s1">__contains__(self</span><span class="s2">, </span><span class="s1">tag):</span>
        <span class="s2">return </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">self._tags_v2 </span><span class="s2">or </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">self._tagdata</span>

    <span class="s2">def </span><span class="s1">__setitem__(self</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">self._setitem(tag</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">self.legacy_api)</span>

    <span class="s2">def </span><span class="s1">_setitem(self</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">legacy_api):</span>
        <span class="s1">basetypes = (Number</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">str)</span>

        <span class="s1">info = TiffTags.lookup(tag</span><span class="s2">, </span><span class="s1">self.group)</span>
        <span class="s1">values = [value] </span><span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">basetypes) </span><span class="s2">else </span><span class="s1">value</span>

        <span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">self.tagtype:</span>
            <span class="s2">if </span><span class="s1">info.type:</span>
                <span class="s1">self.tagtype[tag] = info.type</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">self.tagtype[tag] = TiffTags.UNDEFINED</span>
                <span class="s2">if </span><span class="s1">all(isinstance(v</span><span class="s2">, </span><span class="s1">IFDRational) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                    <span class="s1">self.tagtype[tag] = (</span>
                        <span class="s1">TiffTags.RATIONAL</span>
                        <span class="s2">if </span><span class="s1">all(v &gt;= </span><span class="s3">0 </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values)</span>
                        <span class="s2">else </span><span class="s1">TiffTags.SIGNED_RATIONAL</span>
                    <span class="s1">)</span>
                <span class="s2">elif </span><span class="s1">all(isinstance(v</span><span class="s2">, </span><span class="s1">int) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                    <span class="s2">if </span><span class="s1">all(</span><span class="s3">0 </span><span class="s1">&lt;= v &lt; </span><span class="s3">2</span><span class="s1">**</span><span class="s3">16 </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                        <span class="s1">self.tagtype[tag] = TiffTags.SHORT</span>
                    <span class="s2">elif </span><span class="s1">all(-(</span><span class="s3">2</span><span class="s1">**</span><span class="s3">15</span><span class="s1">) &lt; v &lt; </span><span class="s3">2</span><span class="s1">**</span><span class="s3">15 </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                        <span class="s1">self.tagtype[tag] = TiffTags.SIGNED_SHORT</span>
                    <span class="s2">else</span><span class="s1">:</span>
                        <span class="s1">self.tagtype[tag] = (</span>
                            <span class="s1">TiffTags.LONG</span>
                            <span class="s2">if </span><span class="s1">all(v &gt;= </span><span class="s3">0 </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values)</span>
                            <span class="s2">else </span><span class="s1">TiffTags.SIGNED_LONG</span>
                        <span class="s1">)</span>
                <span class="s2">elif </span><span class="s1">all(isinstance(v</span><span class="s2">, </span><span class="s1">float) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                    <span class="s1">self.tagtype[tag] = TiffTags.DOUBLE</span>
                <span class="s2">elif </span><span class="s1">all(isinstance(v</span><span class="s2">, </span><span class="s1">str) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                    <span class="s1">self.tagtype[tag] = TiffTags.ASCII</span>
                <span class="s2">elif </span><span class="s1">all(isinstance(v</span><span class="s2">, </span><span class="s1">bytes) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values):</span>
                    <span class="s1">self.tagtype[tag] = TiffTags.BYTE</span>

        <span class="s2">if </span><span class="s1">self.tagtype[tag] == TiffTags.UNDEFINED:</span>
            <span class="s1">values = [</span>
                <span class="s1">v.encode(</span><span class="s5">&quot;ascii&quot;</span><span class="s2">, </span><span class="s5">&quot;replace&quot;</span><span class="s1">) </span><span class="s2">if </span><span class="s1">isinstance(v</span><span class="s2">, </span><span class="s1">str) </span><span class="s2">else </span><span class="s1">v</span>
                <span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values</span>
            <span class="s1">]</span>
        <span class="s2">elif </span><span class="s1">self.tagtype[tag] == TiffTags.RATIONAL:</span>
            <span class="s1">values = [float(v) </span><span class="s2">if </span><span class="s1">isinstance(v</span><span class="s2">, </span><span class="s1">int) </span><span class="s2">else </span><span class="s1">v </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">values]</span>

        <span class="s1">is_ifd = self.tagtype[tag] == TiffTags.LONG </span><span class="s2">and </span><span class="s1">isinstance(values</span><span class="s2">, </span><span class="s1">dict)</span>
        <span class="s2">if not </span><span class="s1">is_ifd:</span>
            <span class="s1">values = tuple(info.cvt_enum(value) </span><span class="s2">for </span><span class="s1">value </span><span class="s2">in </span><span class="s1">values)</span>

        <span class="s1">dest = self._tags_v1 </span><span class="s2">if </span><span class="s1">legacy_api </span><span class="s2">else </span><span class="s1">self._tags_v2</span>

        <span class="s0"># Three branches:</span>
        <span class="s0"># Spec'd length == 1, Actual length 1, store as element</span>
        <span class="s0"># Spec'd length == 1, Actual &gt; 1, Warn and truncate. Formerly barfed.</span>
        <span class="s0"># No Spec, Actual length 1, Formerly (&lt;4.2) returned a 1 element tuple.</span>
        <span class="s0"># Don't mess with the legacy api, since it's frozen.</span>
        <span class="s2">if not </span><span class="s1">is_ifd </span><span class="s2">and </span><span class="s1">(</span>
            <span class="s1">(info.length == </span><span class="s3">1</span><span class="s1">)</span>
            <span class="s2">or </span><span class="s1">self.tagtype[tag] == TiffTags.BYTE</span>
            <span class="s2">or </span><span class="s1">(info.length </span><span class="s2">is None and </span><span class="s1">len(values) == </span><span class="s3">1 </span><span class="s2">and not </span><span class="s1">legacy_api)</span>
        <span class="s1">):</span>
            <span class="s0"># Don't mess with the legacy api, since it's frozen.</span>
            <span class="s2">if </span><span class="s1">legacy_api </span><span class="s2">and </span><span class="s1">self.tagtype[tag] </span><span class="s2">in </span><span class="s1">[</span>
                <span class="s1">TiffTags.RATIONAL</span><span class="s2">,</span>
                <span class="s1">TiffTags.SIGNED_RATIONAL</span><span class="s2">,</span>
            <span class="s1">]:  </span><span class="s0"># rationals</span>
                <span class="s1">values = (values</span><span class="s2">,</span><span class="s1">)</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">(dest[tag]</span><span class="s2">,</span><span class="s1">) = values</span>
            <span class="s2">except </span><span class="s1">ValueError:</span>
                <span class="s0"># We've got a builtin tag with 1 expected entry</span>
                <span class="s1">warnings.warn(</span>
                    <span class="s5">f&quot;Metadata Warning, tag </span><span class="s2">{</span><span class="s1">tag</span><span class="s2">} </span><span class="s5">had too many entries: &quot;</span>
                    <span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">len(values)</span><span class="s2">}</span><span class="s5">, expected 1&quot;</span>
                <span class="s1">)</span>
                <span class="s1">dest[tag] = values[</span><span class="s3">0</span><span class="s1">]</span>

        <span class="s2">else</span><span class="s1">:</span>
            <span class="s0"># Spec'd length &gt; 1 or undefined</span>
            <span class="s0"># Unspec'd, and length &gt; 1</span>
            <span class="s1">dest[tag] = values</span>

    <span class="s2">def </span><span class="s1">__delitem__(self</span><span class="s2">, </span><span class="s1">tag):</span>
        <span class="s1">self._tags_v2.pop(tag</span><span class="s2">, None</span><span class="s1">)</span>
        <span class="s1">self._tags_v1.pop(tag</span><span class="s2">, None</span><span class="s1">)</span>
        <span class="s1">self._tagdata.pop(tag</span><span class="s2">, None</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">__iter__(self):</span>
        <span class="s2">return </span><span class="s1">iter(set(self._tagdata) | set(self._tags_v2))</span>

    <span class="s2">def </span><span class="s1">_unpack(self</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">data):</span>
        <span class="s2">return </span><span class="s1">struct.unpack(self._endian + fmt</span><span class="s2">, </span><span class="s1">data)</span>

    <span class="s2">def </span><span class="s1">_pack(self</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">*values):</span>
        <span class="s2">return </span><span class="s1">struct.pack(self._endian + fmt</span><span class="s2">, </span><span class="s1">*values)</span>

    <span class="s2">def </span><span class="s1">_register_loader(idx</span><span class="s2">, </span><span class="s1">size):</span>
        <span class="s2">def </span><span class="s1">decorator(func):</span>
            <span class="s2">from </span><span class="s1">.TiffTags </span><span class="s2">import </span><span class="s1">TYPES</span>

            <span class="s2">if </span><span class="s1">func.__name__.startswith(</span><span class="s5">&quot;load_&quot;</span><span class="s1">):</span>
                <span class="s1">TYPES[idx] = func.__name__[</span><span class="s3">5</span><span class="s1">:].replace(</span><span class="s5">&quot;_&quot;</span><span class="s2">, </span><span class="s5">&quot; &quot;</span><span class="s1">)</span>
            <span class="s1">_load_dispatch[idx] = size</span><span class="s2">, </span><span class="s1">func  </span><span class="s0"># noqa: F821</span>
            <span class="s2">return </span><span class="s1">func</span>

        <span class="s2">return </span><span class="s1">decorator</span>

    <span class="s2">def </span><span class="s1">_register_writer(idx):</span>
        <span class="s2">def </span><span class="s1">decorator(func):</span>
            <span class="s1">_write_dispatch[idx] = func  </span><span class="s0"># noqa: F821</span>
            <span class="s2">return </span><span class="s1">func</span>

        <span class="s2">return </span><span class="s1">decorator</span>

    <span class="s2">def </span><span class="s1">_register_basic(idx_fmt_name):</span>
        <span class="s2">from </span><span class="s1">.TiffTags </span><span class="s2">import </span><span class="s1">TYPES</span>

        <span class="s1">idx</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">name = idx_fmt_name</span>
        <span class="s1">TYPES[idx] = name</span>
        <span class="s1">size = struct.calcsize(</span><span class="s5">&quot;=&quot; </span><span class="s1">+ fmt)</span>
        <span class="s1">_load_dispatch[idx] = (  </span><span class="s0"># noqa: F821</span>
            <span class="s1">size</span><span class="s2">,</span>
            <span class="s2">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">: (</span>
                <span class="s1">self._unpack(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">len(data) // size</span><span class="s2">}{</span><span class="s1">fmt</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s2">, </span><span class="s1">data)</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">_write_dispatch[idx] = </span><span class="s2">lambda </span><span class="s1">self</span><span class="s2">, </span><span class="s1">*values: (  </span><span class="s0"># noqa: F821</span>
            <span class="s4">b&quot;&quot;</span><span class="s1">.join(self._pack(fmt</span><span class="s2">, </span><span class="s1">value) </span><span class="s2">for </span><span class="s1">value </span><span class="s2">in </span><span class="s1">values)</span>
        <span class="s1">)</span>

    <span class="s1">list(</span>
        <span class="s1">map(</span>
            <span class="s1">_register_basic</span><span class="s2">,</span>
            <span class="s1">[</span>
                <span class="s1">(TiffTags.SHORT</span><span class="s2">, </span><span class="s5">&quot;H&quot;</span><span class="s2">, </span><span class="s5">&quot;short&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.LONG</span><span class="s2">, </span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;long&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.SIGNED_BYTE</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;signed byte&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.SIGNED_SHORT</span><span class="s2">, </span><span class="s5">&quot;h&quot;</span><span class="s2">, </span><span class="s5">&quot;signed short&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.SIGNED_LONG</span><span class="s2">, </span><span class="s5">&quot;l&quot;</span><span class="s2">, </span><span class="s5">&quot;signed long&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.FLOAT</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;float&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.DOUBLE</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;double&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.IFD</span><span class="s2">, </span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s5">&quot;long&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">(TiffTags.LONG8</span><span class="s2">, </span><span class="s5">&quot;Q&quot;</span><span class="s2">, </span><span class="s5">&quot;long8&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">@_register_loader(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)  </span><span class="s0"># Basic type, except for the legacy API.</span>
    <span class="s2">def </span><span class="s1">load_byte(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">data</span>

    <span class="s1">@_register_writer(</span><span class="s3">1</span><span class="s1">)  </span><span class="s0"># Basic type, except for the legacy API.</span>
    <span class="s2">def </span><span class="s1">write_byte(self</span><span class="s2">, </span><span class="s1">data):</span>
        <span class="s2">if </span><span class="s1">isinstance(data</span><span class="s2">, </span><span class="s1">int):</span>
            <span class="s1">data = bytes((data</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s2">return </span><span class="s1">data</span>

    <span class="s1">@_register_loader(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">load_string(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s2">if </span><span class="s1">data.endswith(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s1">):</span>
            <span class="s1">data = data[:-</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s2">return </span><span class="s1">data.decode(</span><span class="s5">&quot;latin-1&quot;</span><span class="s2">, </span><span class="s5">&quot;replace&quot;</span><span class="s1">)</span>

    <span class="s1">@_register_writer(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">write_string(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s0"># remerge of https://github.com/python-pillow/Pillow/pull/1416</span>
        <span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">int):</span>
            <span class="s1">value = str(value)</span>
        <span class="s2">if not </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">bytes):</span>
            <span class="s1">value = value.encode(</span><span class="s5">&quot;ascii&quot;</span><span class="s2">, </span><span class="s5">&quot;replace&quot;</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">value + </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span>

    <span class="s1">@_register_loader(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">load_rational(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s1">vals = self._unpack(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">len(data) // </span><span class="s3">4</span><span class="s2">}</span><span class="s5">L&quot;</span><span class="s2">, </span><span class="s1">data)</span>

        <span class="s2">def </span><span class="s1">combine(a</span><span class="s2">, </span><span class="s1">b):</span>
            <span class="s2">return </span><span class="s1">(a</span><span class="s2">, </span><span class="s1">b) </span><span class="s2">if </span><span class="s1">legacy_api </span><span class="s2">else </span><span class="s1">IFDRational(a</span><span class="s2">, </span><span class="s1">b)</span>

        <span class="s2">return </span><span class="s1">tuple(combine(num</span><span class="s2">, </span><span class="s1">denom) </span><span class="s2">for </span><span class="s1">num</span><span class="s2">, </span><span class="s1">denom </span><span class="s2">in </span><span class="s1">zip(vals[::</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">vals[</span><span class="s3">1</span><span class="s1">::</span><span class="s3">2</span><span class="s1">]))</span>

    <span class="s1">@_register_writer(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">write_rational(self</span><span class="s2">, </span><span class="s1">*values):</span>
        <span class="s2">return </span><span class="s4">b&quot;&quot;</span><span class="s1">.join(</span>
            <span class="s1">self._pack(</span><span class="s5">&quot;2L&quot;</span><span class="s2">, </span><span class="s1">*_limit_rational(frac</span><span class="s2">, </span><span class="s3">2</span><span class="s1">**</span><span class="s3">32 </span><span class="s1">- </span><span class="s3">1</span><span class="s1">)) </span><span class="s2">for </span><span class="s1">frac </span><span class="s2">in </span><span class="s1">values</span>
        <span class="s1">)</span>

    <span class="s1">@_register_loader(</span><span class="s3">7</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">load_undefined(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">data</span>

    <span class="s1">@_register_writer(</span><span class="s3">7</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">write_undefined(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s2">return </span><span class="s1">value</span>

    <span class="s1">@_register_loader(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">load_signed_rational(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy_api=</span><span class="s2">True</span><span class="s1">):</span>
        <span class="s1">vals = self._unpack(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">len(data) // </span><span class="s3">4</span><span class="s2">}</span><span class="s5">l&quot;</span><span class="s2">, </span><span class="s1">data)</span>

        <span class="s2">def </span><span class="s1">combine(a</span><span class="s2">, </span><span class="s1">b):</span>
            <span class="s2">return </span><span class="s1">(a</span><span class="s2">, </span><span class="s1">b) </span><span class="s2">if </span><span class="s1">legacy_api </span><span class="s2">else </span><span class="s1">IFDRational(a</span><span class="s2">, </span><span class="s1">b)</span>

        <span class="s2">return </span><span class="s1">tuple(combine(num</span><span class="s2">, </span><span class="s1">denom) </span><span class="s2">for </span><span class="s1">num</span><span class="s2">, </span><span class="s1">denom </span><span class="s2">in </span><span class="s1">zip(vals[::</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">vals[</span><span class="s3">1</span><span class="s1">::</span><span class="s3">2</span><span class="s1">]))</span>

    <span class="s1">@_register_writer(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">write_signed_rational(self</span><span class="s2">, </span><span class="s1">*values):</span>
        <span class="s2">return </span><span class="s4">b&quot;&quot;</span><span class="s1">.join(</span>
            <span class="s1">self._pack(</span><span class="s5">&quot;2l&quot;</span><span class="s2">, </span><span class="s1">*_limit_signed_rational(frac</span><span class="s2">, </span><span class="s3">2</span><span class="s1">**</span><span class="s3">31 </span><span class="s1">- </span><span class="s3">1</span><span class="s2">, </span><span class="s1">-(</span><span class="s3">2</span><span class="s1">**</span><span class="s3">31</span><span class="s1">)))</span>
            <span class="s2">for </span><span class="s1">frac </span><span class="s2">in </span><span class="s1">values</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_ensure_read(self</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">size):</span>
        <span class="s1">ret = fp.read(size)</span>
        <span class="s2">if </span><span class="s1">len(ret) != size:</span>
            <span class="s1">msg = (</span>
                <span class="s5">&quot;Corrupt EXIF data.  &quot;</span>
                <span class="s5">f&quot;Expecting to read </span><span class="s2">{</span><span class="s1">size</span><span class="s2">} </span><span class="s5">bytes but only got </span><span class="s2">{</span><span class="s1">len(ret)</span><span class="s2">}</span><span class="s5">. &quot;</span>
            <span class="s1">)</span>
            <span class="s2">raise </span><span class="s1">OSError(msg)</span>
        <span class="s2">return </span><span class="s1">ret</span>

    <span class="s2">def </span><span class="s1">load(self</span><span class="s2">, </span><span class="s1">fp):</span>

        <span class="s1">self.reset()</span>
        <span class="s1">self._offset = fp.tell()</span>

        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">tag_count = (</span>
                <span class="s1">self._unpack(</span><span class="s5">&quot;Q&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">8</span><span class="s1">))</span>
                <span class="s2">if </span><span class="s1">self._bigtiff</span>
                <span class="s2">else </span><span class="s1">self._unpack(</span><span class="s5">&quot;H&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">2</span><span class="s1">))</span>
            <span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(tag_count):</span>
                <span class="s1">tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">data = (</span>
                    <span class="s1">self._unpack(</span><span class="s5">&quot;HHQ8s&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">20</span><span class="s1">))</span>
                    <span class="s2">if </span><span class="s1">self._bigtiff</span>
                    <span class="s2">else </span><span class="s1">self._unpack(</span><span class="s5">&quot;HHL4s&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">12</span><span class="s1">))</span>
                <span class="s1">)</span>

                <span class="s1">tagname = TiffTags.lookup(tag</span><span class="s2">, </span><span class="s1">self.group).name</span>
                <span class="s1">typname = TYPES.get(typ</span><span class="s2">, </span><span class="s5">&quot;unknown&quot;</span><span class="s1">)</span>
                <span class="s1">msg = </span><span class="s5">f&quot;tag: </span><span class="s2">{</span><span class="s1">tagname</span><span class="s2">} </span><span class="s5">(</span><span class="s2">{</span><span class="s1">tag</span><span class="s2">}</span><span class="s5">) - type: </span><span class="s2">{</span><span class="s1">typname</span><span class="s2">} </span><span class="s5">(</span><span class="s2">{</span><span class="s1">typ</span><span class="s2">}</span><span class="s5">)&quot;</span>

                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">unit_size</span><span class="s2">, </span><span class="s1">handler = self._load_dispatch[typ]</span>
                <span class="s2">except </span><span class="s1">KeyError:</span>
                    <span class="s1">logger.debug(msg + </span><span class="s5">f&quot; - unsupported type </span><span class="s2">{</span><span class="s1">typ</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
                    <span class="s2">continue  </span><span class="s0"># ignore unsupported type</span>
                <span class="s1">size = count * unit_size</span>
                <span class="s2">if </span><span class="s1">size &gt; (</span><span class="s3">8 </span><span class="s2">if </span><span class="s1">self._bigtiff </span><span class="s2">else </span><span class="s3">4</span><span class="s1">):</span>
                    <span class="s1">here = fp.tell()</span>
                    <span class="s1">(offset</span><span class="s2">,</span><span class="s1">) = self._unpack(</span><span class="s5">&quot;Q&quot; </span><span class="s2">if </span><span class="s1">self._bigtiff </span><span class="s2">else </span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">data)</span>
                    <span class="s1">msg += </span><span class="s5">f&quot; Tag Location: </span><span class="s2">{</span><span class="s1">here</span><span class="s2">} </span><span class="s5">- Data Location: </span><span class="s2">{</span><span class="s1">offset</span><span class="s2">}</span><span class="s5">&quot;</span>
                    <span class="s1">fp.seek(offset)</span>
                    <span class="s1">data = ImageFile._safe_read(fp</span><span class="s2">, </span><span class="s1">size)</span>
                    <span class="s1">fp.seek(here)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">data = data[:size]</span>

                <span class="s2">if </span><span class="s1">len(data) != size:</span>
                    <span class="s1">warnings.warn(</span>
                        <span class="s5">&quot;Possibly corrupt EXIF data.  &quot;</span>
                        <span class="s5">f&quot;Expecting to read </span><span class="s2">{</span><span class="s1">size</span><span class="s2">} </span><span class="s5">bytes but only got </span><span class="s2">{</span><span class="s1">len(data)</span><span class="s2">}</span><span class="s5">.&quot;</span>
                        <span class="s5">f&quot; Skipping tag </span><span class="s2">{</span><span class="s1">tag</span><span class="s2">}</span><span class="s5">&quot;</span>
                    <span class="s1">)</span>
                    <span class="s1">logger.debug(msg)</span>
                    <span class="s2">continue</span>

                <span class="s2">if not </span><span class="s1">data:</span>
                    <span class="s1">logger.debug(msg)</span>
                    <span class="s2">continue</span>

                <span class="s1">self._tagdata[tag] = data</span>
                <span class="s1">self.tagtype[tag] = typ</span>

                <span class="s1">msg += </span><span class="s5">&quot; - value: &quot; </span><span class="s1">+ (</span>
                    <span class="s5">&quot;&lt;table: %d bytes&gt;&quot; </span><span class="s1">% size </span><span class="s2">if </span><span class="s1">size &gt; </span><span class="s3">32 </span><span class="s2">else </span><span class="s1">repr(data)</span>
                <span class="s1">)</span>
                <span class="s1">logger.debug(msg)</span>

            <span class="s1">(self.next</span><span class="s2">,</span><span class="s1">) = (</span>
                <span class="s1">self._unpack(</span><span class="s5">&quot;Q&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">8</span><span class="s1">))</span>
                <span class="s2">if </span><span class="s1">self._bigtiff</span>
                <span class="s2">else </span><span class="s1">self._unpack(</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">self._ensure_read(fp</span><span class="s2">, </span><span class="s3">4</span><span class="s1">))</span>
            <span class="s1">)</span>
        <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">msg:</span>
            <span class="s1">warnings.warn(str(msg))</span>
            <span class="s2">return</span>

    <span class="s2">def </span><span class="s1">tobytes(self</span><span class="s2">, </span><span class="s1">offset=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s0"># FIXME What about tagdata?</span>
        <span class="s1">result = self._pack(</span><span class="s5">&quot;H&quot;</span><span class="s2">, </span><span class="s1">len(self._tags_v2))</span>

        <span class="s1">entries = []</span>
        <span class="s1">offset = offset + len(result) + len(self._tags_v2) * </span><span class="s3">12 </span><span class="s1">+ </span><span class="s3">4</span>
        <span class="s1">stripoffsets = </span><span class="s2">None</span>

        <span class="s0"># pass 1: convert tags to binary format</span>
        <span class="s0"># always write tags in ascending order</span>
        <span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">sorted(self._tags_v2.items()):</span>
            <span class="s2">if </span><span class="s1">tag == STRIPOFFSETS:</span>
                <span class="s1">stripoffsets = len(entries)</span>
            <span class="s1">typ = self.tagtype.get(tag)</span>
            <span class="s1">logger.debug(</span><span class="s5">f&quot;Tag </span><span class="s2">{</span><span class="s1">tag</span><span class="s2">}</span><span class="s5">, Type: </span><span class="s2">{</span><span class="s1">typ</span><span class="s2">}</span><span class="s5">, Value: </span><span class="s2">{</span><span class="s1">repr(value)</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
            <span class="s1">is_ifd = typ == TiffTags.LONG </span><span class="s2">and </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">dict)</span>
            <span class="s2">if </span><span class="s1">is_ifd:</span>
                <span class="s2">if </span><span class="s1">self._endian == </span><span class="s5">&quot;&lt;&quot;</span><span class="s1">:</span>
                    <span class="s1">ifh = </span><span class="s4">b&quot;II</span><span class="s2">\x2A\x00\x08\x00\x00\x00</span><span class="s4">&quot;</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">ifh = </span><span class="s4">b&quot;MM</span><span class="s2">\x00\x2A\x00\x00\x00\x08</span><span class="s4">&quot;</span>
                <span class="s1">ifd = ImageFileDirectory_v2(ifh</span><span class="s2">, </span><span class="s1">group=tag)</span>
                <span class="s1">values = self._tags_v2[tag]</span>
                <span class="s2">for </span><span class="s1">ifd_tag</span><span class="s2">, </span><span class="s1">ifd_value </span><span class="s2">in </span><span class="s1">values.items():</span>
                    <span class="s1">ifd[ifd_tag] = ifd_value</span>
                <span class="s1">data = ifd.tobytes(offset)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">values = value </span><span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">tuple) </span><span class="s2">else </span><span class="s1">(value</span><span class="s2">,</span><span class="s1">)</span>
                <span class="s1">data = self._write_dispatch[typ](self</span><span class="s2">, </span><span class="s1">*values)</span>

            <span class="s1">tagname = TiffTags.lookup(tag</span><span class="s2">, </span><span class="s1">self.group).name</span>
            <span class="s1">typname = </span><span class="s5">&quot;ifd&quot; </span><span class="s2">if </span><span class="s1">is_ifd </span><span class="s2">else </span><span class="s1">TYPES.get(typ</span><span class="s2">, </span><span class="s5">&quot;unknown&quot;</span><span class="s1">)</span>
            <span class="s1">msg = </span><span class="s5">f&quot;save: </span><span class="s2">{</span><span class="s1">tagname</span><span class="s2">} </span><span class="s5">(</span><span class="s2">{</span><span class="s1">tag</span><span class="s2">}</span><span class="s5">) - type: </span><span class="s2">{</span><span class="s1">typname</span><span class="s2">} </span><span class="s5">(</span><span class="s2">{</span><span class="s1">typ</span><span class="s2">}</span><span class="s5">)&quot;</span>
            <span class="s1">msg += </span><span class="s5">&quot; - value: &quot; </span><span class="s1">+ (</span>
                <span class="s5">&quot;&lt;table: %d bytes&gt;&quot; </span><span class="s1">% len(data) </span><span class="s2">if </span><span class="s1">len(data) &gt;= </span><span class="s3">16 </span><span class="s2">else </span><span class="s1">str(values)</span>
            <span class="s1">)</span>
            <span class="s1">logger.debug(msg)</span>

            <span class="s0"># count is sum of lengths for string and arbitrary data</span>
            <span class="s2">if </span><span class="s1">is_ifd:</span>
                <span class="s1">count = </span><span class="s3">1</span>
            <span class="s2">elif </span><span class="s1">typ </span><span class="s2">in </span><span class="s1">[TiffTags.BYTE</span><span class="s2">, </span><span class="s1">TiffTags.ASCII</span><span class="s2">, </span><span class="s1">TiffTags.UNDEFINED]:</span>
                <span class="s1">count = len(data)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">count = len(values)</span>
            <span class="s0"># figure out if data fits into the entry</span>
            <span class="s2">if </span><span class="s1">len(data) &lt;= </span><span class="s3">4</span><span class="s1">:</span>
                <span class="s1">entries.append((tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">data.ljust(</span><span class="s3">4</span><span class="s2">, </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s4">b&quot;&quot;</span><span class="s1">))</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">entries.append((tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">self._pack(</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">offset)</span><span class="s2">, </span><span class="s1">data))</span>
                <span class="s1">offset += (len(data) + </span><span class="s3">1</span><span class="s1">) // </span><span class="s3">2 </span><span class="s1">* </span><span class="s3">2  </span><span class="s0"># pad to word</span>

        <span class="s0"># update strip offset data to point beyond auxiliary data</span>
        <span class="s2">if </span><span class="s1">stripoffsets </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">data = entries[stripoffsets]</span>
            <span class="s2">if </span><span class="s1">data:</span>
                <span class="s1">msg = </span><span class="s5">&quot;multistrip support not yet implemented&quot;</span>
                <span class="s2">raise </span><span class="s1">NotImplementedError(msg)</span>
            <span class="s1">value = self._pack(</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">self._unpack(</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">value)[</span><span class="s3">0</span><span class="s1">] + offset)</span>
            <span class="s1">entries[stripoffsets] = tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">data</span>

        <span class="s0"># pass 2: write entries to file</span>
        <span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">data </span><span class="s2">in </span><span class="s1">entries:</span>
            <span class="s1">logger.debug(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">tag</span><span class="s2">} {</span><span class="s1">typ</span><span class="s2">} {</span><span class="s1">count</span><span class="s2">} {</span><span class="s1">repr(value)</span><span class="s2">} {</span><span class="s1">repr(data)</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
            <span class="s1">result += self._pack(</span><span class="s5">&quot;HHL4s&quot;</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">value)</span>

        <span class="s0"># -- overwrite here for multi-page --</span>
        <span class="s1">result += </span><span class="s4">b&quot;</span><span class="s2">\0\0\0\0</span><span class="s4">&quot;  </span><span class="s0"># end of entries</span>

        <span class="s0"># pass 3: write auxiliary data to file</span>
        <span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">typ</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">data </span><span class="s2">in </span><span class="s1">entries:</span>
            <span class="s1">result += data</span>
            <span class="s2">if </span><span class="s1">len(data) &amp; </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">result += </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span>

        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">save(self</span><span class="s2">, </span><span class="s1">fp):</span>

        <span class="s2">if </span><span class="s1">fp.tell() == </span><span class="s3">0</span><span class="s1">:  </span><span class="s0"># skip TIFF header on subsequent pages</span>
            <span class="s0"># tiff header -- PIL always starts the first IFD at offset 8</span>
            <span class="s1">fp.write(self._prefix + self._pack(</span><span class="s5">&quot;HL&quot;</span><span class="s2">, </span><span class="s3">42</span><span class="s2">, </span><span class="s3">8</span><span class="s1">))</span>

        <span class="s1">offset = fp.tell()</span>
        <span class="s1">result = self.tobytes(offset)</span>
        <span class="s1">fp.write(result)</span>
        <span class="s2">return </span><span class="s1">offset + len(result)</span>


<span class="s1">ImageFileDirectory_v2._load_dispatch = _load_dispatch</span>
<span class="s1">ImageFileDirectory_v2._write_dispatch = _write_dispatch</span>
<span class="s2">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name </span><span class="s2">in </span><span class="s1">TYPES.items():</span>
    <span class="s1">name = name.replace(</span><span class="s5">&quot; &quot;</span><span class="s2">, </span><span class="s5">&quot;_&quot;</span><span class="s1">)</span>
    <span class="s1">setattr(ImageFileDirectory_v2</span><span class="s2">, </span><span class="s5">&quot;load_&quot; </span><span class="s1">+ name</span><span class="s2">, </span><span class="s1">_load_dispatch[idx][</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">setattr(ImageFileDirectory_v2</span><span class="s2">, </span><span class="s5">&quot;write_&quot; </span><span class="s1">+ name</span><span class="s2">, </span><span class="s1">_write_dispatch[idx])</span>
<span class="s2">del </span><span class="s1">_load_dispatch</span><span class="s2">, </span><span class="s1">_write_dispatch</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">name</span>


<span class="s0"># Legacy ImageFileDirectory support.</span>
<span class="s2">class </span><span class="s1">ImageFileDirectory_v1(ImageFileDirectory_v2):</span>
    <span class="s6">&quot;&quot;&quot;This class represents the **legacy** interface to a TIFF tag directory. 
 
    Exposes a dictionary interface of the tags in the directory:: 
 
        ifd = ImageFileDirectory_v1() 
        ifd[key] = 'Some Data' 
        ifd.tagtype[key] = TiffTags.ASCII 
        print(ifd[key]) 
        ('Some Data',) 
 
    Also contains a dictionary of tag types as read from the tiff image file, 
    :attr:`~PIL.TiffImagePlugin.ImageFileDirectory_v1.tagtype`. 
 
    Values are returned as a tuple. 
 
    ..  deprecated:: 3.0.0 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">super().__init__(*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>
        <span class="s1">self._legacy_api = </span><span class="s2">True</span>

    <span class="s1">tags = property(</span><span class="s2">lambda </span><span class="s1">self: self._tags_v1)</span>
    <span class="s1">tagdata = property(</span><span class="s2">lambda </span><span class="s1">self: self._tagdata)</span>

    <span class="s0"># defined in ImageFileDirectory_v2</span>
    <span class="s1">tagtype: dict</span>
    <span class="s5">&quot;&quot;&quot;Dictionary of tag types&quot;&quot;&quot;</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">from_v2(cls</span><span class="s2">, </span><span class="s1">original):</span>
        <span class="s6">&quot;&quot;&quot;Returns an 
        :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v1` 
        instance with the same data as is contained in the original 
        :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v2` 
        instance. 
 
        :returns: :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v1` 
 
        &quot;&quot;&quot;</span>

        <span class="s1">ifd = cls(prefix=original.prefix)</span>
        <span class="s1">ifd._tagdata = original._tagdata</span>
        <span class="s1">ifd.tagtype = original.tagtype</span>
        <span class="s1">ifd.next = original.next  </span><span class="s0"># an indicator for multipage tiffs</span>
        <span class="s2">return </span><span class="s1">ifd</span>

    <span class="s2">def </span><span class="s1">to_v2(self):</span>
        <span class="s6">&quot;&quot;&quot;Returns an 
        :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v2` 
        instance with the same data as is contained in the original 
        :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v1` 
        instance. 
 
        :returns: :py:class:`~PIL.TiffImagePlugin.ImageFileDirectory_v2` 
 
        &quot;&quot;&quot;</span>

        <span class="s1">ifd = ImageFileDirectory_v2(prefix=self.prefix)</span>
        <span class="s1">ifd._tagdata = dict(self._tagdata)</span>
        <span class="s1">ifd.tagtype = dict(self.tagtype)</span>
        <span class="s1">ifd._tags_v2 = dict(self._tags_v2)</span>
        <span class="s2">return </span><span class="s1">ifd</span>

    <span class="s2">def </span><span class="s1">__contains__(self</span><span class="s2">, </span><span class="s1">tag):</span>
        <span class="s2">return </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">self._tags_v1 </span><span class="s2">or </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">self._tagdata</span>

    <span class="s2">def </span><span class="s1">__len__(self):</span>
        <span class="s2">return </span><span class="s1">len(set(self._tagdata) | set(self._tags_v1))</span>

    <span class="s2">def </span><span class="s1">__iter__(self):</span>
        <span class="s2">return </span><span class="s1">iter(set(self._tagdata) | set(self._tags_v1))</span>

    <span class="s2">def </span><span class="s1">__setitem__(self</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s2">for </span><span class="s1">legacy_api </span><span class="s2">in </span><span class="s1">(</span><span class="s2">False, True</span><span class="s1">):</span>
            <span class="s1">self._setitem(tag</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">legacy_api)</span>

    <span class="s2">def </span><span class="s1">__getitem__(self</span><span class="s2">, </span><span class="s1">tag):</span>
        <span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">self._tags_v1:  </span><span class="s0"># unpack on the fly</span>
            <span class="s1">data = self._tagdata[tag]</span>
            <span class="s1">typ = self.tagtype[tag]</span>
            <span class="s1">size</span><span class="s2">, </span><span class="s1">handler = self._load_dispatch[typ]</span>
            <span class="s2">for </span><span class="s1">legacy </span><span class="s2">in </span><span class="s1">(</span><span class="s2">False, True</span><span class="s1">):</span>
                <span class="s1">self._setitem(tag</span><span class="s2">, </span><span class="s1">handler(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">legacy)</span><span class="s2">, </span><span class="s1">legacy)</span>
        <span class="s1">val = self._tags_v1[tag]</span>
        <span class="s2">if not </span><span class="s1">isinstance(val</span><span class="s2">, </span><span class="s1">(tuple</span><span class="s2">, </span><span class="s1">bytes)):</span>
            <span class="s1">val = (val</span><span class="s2">,</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s1">val</span>


<span class="s0"># undone -- switch this pointer when IFD_LEGACY_API == False</span>
<span class="s1">ImageFileDirectory = ImageFileDirectory_v1</span>


<span class="s0">##</span>
<span class="s0"># Image plugin for TIFF files.</span>


<span class="s2">class </span><span class="s1">TiffImageFile(ImageFile.ImageFile):</span>

    <span class="s1">format = </span><span class="s5">&quot;TIFF&quot;</span>
    <span class="s1">format_description = </span><span class="s5">&quot;Adobe TIFF&quot;</span>
    <span class="s1">_close_exclusive_fp_after_loading = </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">fp=</span><span class="s2">None, </span><span class="s1">filename=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">self.tag_v2 = </span><span class="s2">None</span>
        <span class="s5">&quot;&quot;&quot; Image file directory (tag dictionary) &quot;&quot;&quot;</span>

        <span class="s1">self.tag = </span><span class="s2">None</span>
        <span class="s5">&quot;&quot;&quot; Legacy tag entries &quot;&quot;&quot;</span>

        <span class="s1">super().__init__(fp</span><span class="s2">, </span><span class="s1">filename)</span>

    <span class="s2">def </span><span class="s1">_open(self):</span>
        <span class="s6">&quot;&quot;&quot;Open the first image in a TIFF file&quot;&quot;&quot;</span>

        <span class="s0"># Header</span>
        <span class="s1">ifh = self.fp.read(</span><span class="s3">8</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">ifh[</span><span class="s3">2</span><span class="s1">] == </span><span class="s3">43</span><span class="s1">:</span>
            <span class="s1">ifh += self.fp.read(</span><span class="s3">8</span><span class="s1">)</span>

        <span class="s1">self.tag_v2 = ImageFileDirectory_v2(ifh)</span>

        <span class="s0"># legacy IFD entries will be filled in later</span>
        <span class="s1">self.ifd = </span><span class="s2">None</span>

        <span class="s0"># setup frame pointers</span>
        <span class="s1">self.__first = self.__next = self.tag_v2.next</span>
        <span class="s1">self.__frame = -</span><span class="s3">1</span>
        <span class="s1">self._fp = self.fp</span>
        <span class="s1">self._frame_pos = []</span>
        <span class="s1">self._n_frames = </span><span class="s2">None</span>

        <span class="s1">logger.debug(</span><span class="s5">&quot;*** TiffImageFile._open ***&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- __first: </span><span class="s2">{</span><span class="s1">self.__first</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- ifh: </span><span class="s2">{</span><span class="s1">repr(ifh)</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)  </span><span class="s0"># Use repr to avoid str(bytes)</span>

        <span class="s0"># and load the first frame</span>
        <span class="s1">self._seek(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">@property</span>
    <span class="s2">def </span><span class="s1">n_frames(self):</span>
        <span class="s2">if </span><span class="s1">self._n_frames </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s1">current = self.tell()</span>
            <span class="s1">self._seek(len(self._frame_pos))</span>
            <span class="s2">while </span><span class="s1">self._n_frames </span><span class="s2">is None</span><span class="s1">:</span>
                <span class="s1">self._seek(self.tell() + </span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">self.seek(current)</span>
        <span class="s2">return </span><span class="s1">self._n_frames</span>

    <span class="s2">def </span><span class="s1">seek(self</span><span class="s2">, </span><span class="s1">frame):</span>
        <span class="s6">&quot;&quot;&quot;Select a given frame as current image&quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self._seek_check(frame):</span>
            <span class="s2">return</span>
        <span class="s1">self._seek(frame)</span>
        <span class="s0"># Create a new core image object on second and</span>
        <span class="s0"># subsequent frames in the image. Image may be</span>
        <span class="s0"># different size/mode.</span>
        <span class="s1">Image._decompression_bomb_check(self.size)</span>
        <span class="s1">self.im = Image.core.new(self.mode</span><span class="s2">, </span><span class="s1">self.size)</span>

    <span class="s2">def </span><span class="s1">_seek(self</span><span class="s2">, </span><span class="s1">frame):</span>
        <span class="s1">self.fp = self._fp</span>

        <span class="s0"># reset buffered io handle in case fp</span>
        <span class="s0"># was passed to libtiff, invalidating the buffer</span>
        <span class="s1">self.fp.tell()</span>

        <span class="s2">while </span><span class="s1">len(self._frame_pos) &lt;= frame:</span>
            <span class="s2">if not </span><span class="s1">self.__next:</span>
                <span class="s1">msg = </span><span class="s5">&quot;no more images in TIFF file&quot;</span>
                <span class="s2">raise </span><span class="s1">EOFError(msg)</span>
            <span class="s1">logger.debug(</span>
                <span class="s5">f&quot;Seeking to frame </span><span class="s2">{</span><span class="s1">frame</span><span class="s2">}</span><span class="s5">, on frame </span><span class="s2">{</span><span class="s1">self.__frame</span><span class="s2">}</span><span class="s5">, &quot;</span>
                <span class="s5">f&quot;__next </span><span class="s2">{</span><span class="s1">self.__next</span><span class="s2">}</span><span class="s5">, location: </span><span class="s2">{</span><span class="s1">self.fp.tell()</span><span class="s2">}</span><span class="s5">&quot;</span>
            <span class="s1">)</span>
            <span class="s1">self.fp.seek(self.__next)</span>
            <span class="s1">self._frame_pos.append(self.__next)</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;Loading tags, location: %s&quot; </span><span class="s1">% self.fp.tell())</span>
            <span class="s1">self.tag_v2.load(self.fp)</span>
            <span class="s2">if </span><span class="s1">self.tag_v2.next </span><span class="s2">in </span><span class="s1">self._frame_pos:</span>
                <span class="s0"># This IFD has already been processed</span>
                <span class="s0"># Declare this to be the end of the image</span>
                <span class="s1">self.__next = </span><span class="s3">0</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">self.__next = self.tag_v2.next</span>
            <span class="s2">if </span><span class="s1">self.__next == </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s1">self._n_frames = frame + </span><span class="s3">1</span>
            <span class="s2">if </span><span class="s1">len(self._frame_pos) == </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">self.is_animated = self.__next != </span><span class="s3">0</span>
            <span class="s1">self.__frame += </span><span class="s3">1</span>
        <span class="s1">self.fp.seek(self._frame_pos[frame])</span>
        <span class="s1">self.tag_v2.load(self.fp)</span>
        <span class="s1">self._reload_exif()</span>
        <span class="s0"># fill the legacy tag/ifd entries</span>
        <span class="s1">self.tag = self.ifd = ImageFileDirectory_v1.from_v2(self.tag_v2)</span>
        <span class="s1">self.__frame = frame</span>
        <span class="s1">self._setup()</span>

    <span class="s2">def </span><span class="s1">tell(self):</span>
        <span class="s6">&quot;&quot;&quot;Return the current frame number&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self.__frame</span>

    <span class="s2">def </span><span class="s1">getxmp(self):</span>
        <span class="s6">&quot;&quot;&quot; 
        Returns a dictionary containing the XMP tags. 
        Requires defusedxml to be installed. 
 
        :returns: XMP tags in a dictionary. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self._getxmp(self.tag_v2[XMP]) </span><span class="s2">if </span><span class="s1">XMP </span><span class="s2">in </span><span class="s1">self.tag_v2 </span><span class="s2">else </span><span class="s1">{}</span>

    <span class="s2">def </span><span class="s1">get_photoshop_blocks(self):</span>
        <span class="s6">&quot;&quot;&quot; 
        Returns a dictionary of Photoshop &quot;Image Resource Blocks&quot;. 
        The keys are the image resource ID. For more information, see 
        https://www.adobe.com/devnet-apps/photoshop/fileformatashtml/#50577409_pgfId-1037727 
 
        :returns: Photoshop &quot;Image Resource Blocks&quot; in a dictionary. 
        &quot;&quot;&quot;</span>
        <span class="s1">blocks = {}</span>
        <span class="s1">val = self.tag_v2.get(</span><span class="s3">0x8649</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">val:</span>
            <span class="s2">while </span><span class="s1">val[:</span><span class="s3">4</span><span class="s1">] == </span><span class="s4">b&quot;8BIM&quot;</span><span class="s1">:</span>
                <span class="s1">id = i16(val[</span><span class="s3">4</span><span class="s1">:</span><span class="s3">6</span><span class="s1">])</span>
                <span class="s1">n = math.ceil((val[</span><span class="s3">6</span><span class="s1">] + </span><span class="s3">1</span><span class="s1">) / </span><span class="s3">2</span><span class="s1">) * </span><span class="s3">2</span>
                <span class="s1">size = i32(val[</span><span class="s3">6 </span><span class="s1">+ n : </span><span class="s3">10 </span><span class="s1">+ n])</span>
                <span class="s1">data = val[</span><span class="s3">10 </span><span class="s1">+ n : </span><span class="s3">10 </span><span class="s1">+ n + size]</span>
                <span class="s1">blocks[id] = {</span><span class="s5">&quot;data&quot;</span><span class="s1">: data}</span>

                <span class="s1">val = val[math.ceil((</span><span class="s3">10 </span><span class="s1">+ n + size) / </span><span class="s3">2</span><span class="s1">) * </span><span class="s3">2 </span><span class="s1">:]</span>
        <span class="s2">return </span><span class="s1">blocks</span>

    <span class="s2">def </span><span class="s1">load(self):</span>
        <span class="s2">if </span><span class="s1">self.tile </span><span class="s2">and </span><span class="s1">self.use_load_libtiff:</span>
            <span class="s2">return </span><span class="s1">self._load_libtiff()</span>
        <span class="s2">return </span><span class="s1">super().load()</span>

    <span class="s2">def </span><span class="s1">load_end(self):</span>
        <span class="s2">if </span><span class="s1">self._tile_orientation:</span>
            <span class="s1">method = {</span>
                <span class="s3">2</span><span class="s1">: Image.Transpose.FLIP_LEFT_RIGHT</span><span class="s2">,</span>
                <span class="s3">3</span><span class="s1">: Image.Transpose.ROTATE_180</span><span class="s2">,</span>
                <span class="s3">4</span><span class="s1">: Image.Transpose.FLIP_TOP_BOTTOM</span><span class="s2">,</span>
                <span class="s3">5</span><span class="s1">: Image.Transpose.TRANSPOSE</span><span class="s2">,</span>
                <span class="s3">6</span><span class="s1">: Image.Transpose.ROTATE_270</span><span class="s2">,</span>
                <span class="s3">7</span><span class="s1">: Image.Transpose.TRANSVERSE</span><span class="s2">,</span>
                <span class="s3">8</span><span class="s1">: Image.Transpose.ROTATE_90</span><span class="s2">,</span>
            <span class="s1">}.get(self._tile_orientation)</span>
            <span class="s2">if </span><span class="s1">method </span><span class="s2">is not None</span><span class="s1">:</span>
                <span class="s1">self.im = self.im.transpose(method)</span>
                <span class="s1">self._size = self.im.size</span>

        <span class="s0"># allow closing if we're on the first frame, there's no next</span>
        <span class="s0"># This is the ImageFile.load path only, libtiff specific below.</span>
        <span class="s2">if not </span><span class="s1">self.is_animated:</span>
            <span class="s1">self._close_exclusive_fp_after_loading = </span><span class="s2">True</span>

            <span class="s0"># reset buffered io handle in case fp</span>
            <span class="s0"># was passed to libtiff, invalidating the buffer</span>
            <span class="s1">self.fp.tell()</span>

            <span class="s0"># load IFD data from fp before it is closed</span>
            <span class="s1">exif = self.getexif()</span>
            <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">TiffTags.TAGS_V2_GROUPS.keys():</span>
                <span class="s2">if </span><span class="s1">key </span><span class="s2">not in </span><span class="s1">exif:</span>
                    <span class="s2">continue</span>
                <span class="s1">exif.get_ifd(key)</span>

    <span class="s2">def </span><span class="s1">_load_libtiff(self):</span>
        <span class="s6">&quot;&quot;&quot;Overload method triggered when we detect a compressed tiff 
        Calls out to libtiff&quot;&quot;&quot;</span>

        <span class="s1">Image.Image.load(self)</span>

        <span class="s1">self.load_prepare()</span>

        <span class="s2">if not </span><span class="s1">len(self.tile) == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">&quot;Not exactly one tile&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError(msg)</span>

        <span class="s0"># (self._compression, (extents tuple),</span>
        <span class="s0">#   0, (rawmode, self._compression, fp))</span>
        <span class="s1">extents = self.tile[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">args = list(self.tile[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">3</span><span class="s1">])</span>

        <span class="s0"># To be nice on memory footprint, if there's a</span>
        <span class="s0"># file descriptor, use that instead of reading</span>
        <span class="s0"># into a string in python.</span>
        <span class="s0"># libtiff closes the file descriptor, so pass in a dup.</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">fp = hasattr(self.fp</span><span class="s2">, </span><span class="s5">&quot;fileno&quot;</span><span class="s1">) </span><span class="s2">and </span><span class="s1">os.dup(self.fp.fileno())</span>
            <span class="s0"># flush the file descriptor, prevents error on pypy 2.4+</span>
            <span class="s0"># should also eliminate the need for fp.tell</span>
            <span class="s0"># in _seek</span>
            <span class="s2">if </span><span class="s1">hasattr(self.fp</span><span class="s2">, </span><span class="s5">&quot;flush&quot;</span><span class="s1">):</span>
                <span class="s1">self.fp.flush()</span>
        <span class="s2">except </span><span class="s1">OSError:</span>
            <span class="s0"># io.BytesIO have a fileno, but returns an OSError if</span>
            <span class="s0"># it doesn't use a file descriptor.</span>
            <span class="s1">fp = </span><span class="s2">False</span>

        <span class="s2">if </span><span class="s1">fp:</span>
            <span class="s1">args[</span><span class="s3">2</span><span class="s1">] = fp</span>

        <span class="s1">decoder = Image._getdecoder(</span>
            <span class="s1">self.mode</span><span class="s2">, </span><span class="s5">&quot;libtiff&quot;</span><span class="s2">, </span><span class="s1">tuple(args)</span><span class="s2">, </span><span class="s1">self.decoderconfig</span>
        <span class="s1">)</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">decoder.setimage(self.im</span><span class="s2">, </span><span class="s1">extents)</span>
        <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e:</span>
            <span class="s1">msg = </span><span class="s5">&quot;Couldn't set the image&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError(msg) </span><span class="s2">from </span><span class="s1">e</span>

        <span class="s1">close_self_fp = self._exclusive_fp </span><span class="s2">and not </span><span class="s1">self.is_animated</span>
        <span class="s2">if </span><span class="s1">hasattr(self.fp</span><span class="s2">, </span><span class="s5">&quot;getvalue&quot;</span><span class="s1">):</span>
            <span class="s0"># We've got a stringio like thing passed in. Yay for all in memory.</span>
            <span class="s0"># The decoder needs the entire file in one shot, so there's not</span>
            <span class="s0"># a lot we can do here other than give it the entire file.</span>
            <span class="s0"># unless we could do something like get the address of the</span>
            <span class="s0"># underlying string for stringio.</span>
            <span class="s0">#</span>
            <span class="s0"># Rearranging for supporting byteio items, since they have a fileno</span>
            <span class="s0"># that returns an OSError if there's no underlying fp. Easier to</span>
            <span class="s0"># deal with here by reordering.</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;have getvalue. just sending in a string from getvalue&quot;</span><span class="s1">)</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">err = decoder.decode(self.fp.getvalue())</span>
        <span class="s2">elif </span><span class="s1">fp:</span>
            <span class="s0"># we've got a actual file on disk, pass in the fp.</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;have fileno, calling fileno version of the decoder.&quot;</span><span class="s1">)</span>
            <span class="s2">if not </span><span class="s1">close_self_fp:</span>
                <span class="s1">self.fp.seek(</span><span class="s3">0</span><span class="s1">)</span>
            <span class="s0"># 4 bytes, otherwise the trace might error out</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">err = decoder.decode(</span><span class="s4">b&quot;fpfp&quot;</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s0"># we have something else.</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;don't have fileno or getvalue. just reading&quot;</span><span class="s1">)</span>
            <span class="s1">self.fp.seek(</span><span class="s3">0</span><span class="s1">)</span>
            <span class="s0"># UNDONE -- so much for that buffer size thing.</span>
            <span class="s1">n</span><span class="s2">, </span><span class="s1">err = decoder.decode(self.fp.read())</span>

        <span class="s2">if </span><span class="s1">fp:</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">os.close(fp)</span>
            <span class="s2">except </span><span class="s1">OSError:</span>
                <span class="s2">pass</span>

        <span class="s1">self.tile = []</span>
        <span class="s1">self.readonly = </span><span class="s3">0</span>

        <span class="s1">self.load_end()</span>

        <span class="s0"># libtiff closed the fp in a, we need to close self.fp, if possible</span>
        <span class="s2">if </span><span class="s1">close_self_fp:</span>
            <span class="s1">self.fp.close()</span>
            <span class="s1">self.fp = </span><span class="s2">None  </span><span class="s0"># might be shared</span>

        <span class="s2">if </span><span class="s1">err &lt; </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s2">raise </span><span class="s1">OSError(err)</span>

        <span class="s2">return </span><span class="s1">Image.Image.load(self)</span>

    <span class="s2">def </span><span class="s1">_setup(self):</span>
        <span class="s6">&quot;&quot;&quot;Setup this image object based on current tags&quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s3">0xBC01 </span><span class="s2">in </span><span class="s1">self.tag_v2:</span>
            <span class="s1">msg = </span><span class="s5">&quot;Windows Media Photo files not yet supported&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError(msg)</span>

        <span class="s0"># extract relevant tags</span>
        <span class="s1">self._compression = COMPRESSION_INFO[self.tag_v2.get(COMPRESSION</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">self._planar_configuration = self.tag_v2.get(PLANAR_CONFIGURATION</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s0"># photometric is a required tag, but not everyone is reading</span>
        <span class="s0"># the specification</span>
        <span class="s1">photo = self.tag_v2.get(PHOTOMETRIC_INTERPRETATION</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>

        <span class="s0"># old style jpeg compression images most certainly are YCbCr</span>
        <span class="s2">if </span><span class="s1">self._compression == </span><span class="s5">&quot;tiff_jpeg&quot;</span><span class="s1">:</span>
            <span class="s1">photo = </span><span class="s3">6</span>

        <span class="s1">fillorder = self.tag_v2.get(FILLORDER</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">logger.debug(</span><span class="s5">&quot;*** Summary ***&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- compression: </span><span class="s2">{</span><span class="s1">self._compression</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- photometric_interpretation: </span><span class="s2">{</span><span class="s1">photo</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- planar_configuration: </span><span class="s2">{</span><span class="s1">self._planar_configuration</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- fill_order: </span><span class="s2">{</span><span class="s1">fillorder</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- YCbCr subsampling: </span><span class="s2">{</span><span class="s1">self.tag.get(YCBCRSUBSAMPLING)</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>

        <span class="s0"># size</span>
        <span class="s1">xsize = int(self.tag_v2.get(IMAGEWIDTH))</span>
        <span class="s1">ysize = int(self.tag_v2.get(IMAGELENGTH))</span>
        <span class="s1">self._size = xsize</span><span class="s2">, </span><span class="s1">ysize</span>

        <span class="s1">logger.debug(</span><span class="s5">f&quot;- size: </span><span class="s2">{</span><span class="s1">self.size</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>

        <span class="s1">sample_format = self.tag_v2.get(SAMPLEFORMAT</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s2">if </span><span class="s1">len(sample_format) &gt; </span><span class="s3">1 </span><span class="s2">and </span><span class="s1">max(sample_format) == min(sample_format) == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s0"># SAMPLEFORMAT is properly per band, so an RGB image will</span>
            <span class="s0"># be (1,1,1).  But, we don't support per band pixel types,</span>
            <span class="s0"># and anything more than one band is a uint8. So, just</span>
            <span class="s0"># take the first element. Revisit this if adding support</span>
            <span class="s0"># for more exotic images.</span>
            <span class="s1">sample_format = (</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span>

        <span class="s1">bps_tuple = self.tag_v2.get(BITSPERSAMPLE</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">extra_tuple = self.tag_v2.get(EXTRASAMPLES</span><span class="s2">, </span><span class="s1">())</span>
        <span class="s2">if </span><span class="s1">photo </span><span class="s2">in </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s1">):  </span><span class="s0"># RGB, YCbCr, LAB</span>
            <span class="s1">bps_count = </span><span class="s3">3</span>
        <span class="s2">elif </span><span class="s1">photo == </span><span class="s3">5</span><span class="s1">:  </span><span class="s0"># CMYK</span>
            <span class="s1">bps_count = </span><span class="s3">4</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">bps_count = </span><span class="s3">1</span>
        <span class="s1">bps_count += len(extra_tuple)</span>
        <span class="s1">bps_actual_count = len(bps_tuple)</span>
        <span class="s1">samples_per_pixel = self.tag_v2.get(</span>
            <span class="s1">SAMPLESPERPIXEL</span><span class="s2">,</span>
            <span class="s3">3 </span><span class="s2">if </span><span class="s1">self._compression == </span><span class="s5">&quot;tiff_jpeg&quot; </span><span class="s2">and </span><span class="s1">photo </span><span class="s2">in </span><span class="s1">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s1">) </span><span class="s2">else </span><span class="s3">1</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s2">if </span><span class="s1">samples_per_pixel &gt; MAX_SAMPLESPERPIXEL:</span>
            <span class="s0"># DOS check, samples_per_pixel can be a Long, and we extend the tuple below</span>
            <span class="s1">logger.error(</span>
                <span class="s5">&quot;More samples per pixel than can be decoded: %s&quot;</span><span class="s2">, </span><span class="s1">samples_per_pixel</span>
            <span class="s1">)</span>
            <span class="s1">msg = </span><span class="s5">&quot;Invalid value for samples per pixel&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg)</span>

        <span class="s2">if </span><span class="s1">samples_per_pixel &lt; bps_actual_count:</span>
            <span class="s0"># If a file has more values in bps_tuple than expected,</span>
            <span class="s0"># remove the excess.</span>
            <span class="s1">bps_tuple = bps_tuple[:samples_per_pixel]</span>
        <span class="s2">elif </span><span class="s1">samples_per_pixel &gt; bps_actual_count </span><span class="s2">and </span><span class="s1">bps_actual_count == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s0"># If a file has only one value in bps_tuple, when it should have more,</span>
            <span class="s0"># presume it is the same number of bits for all of the samples.</span>
            <span class="s1">bps_tuple = bps_tuple * samples_per_pixel</span>

        <span class="s2">if </span><span class="s1">len(bps_tuple) != samples_per_pixel:</span>
            <span class="s1">msg = </span><span class="s5">&quot;unknown data organization&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg)</span>

        <span class="s0"># mode: check photometric interpretation and bits per pixel</span>
        <span class="s1">key = (</span>
            <span class="s1">self.tag_v2.prefix</span><span class="s2">,</span>
            <span class="s1">photo</span><span class="s2">,</span>
            <span class="s1">sample_format</span><span class="s2">,</span>
            <span class="s1">fillorder</span><span class="s2">,</span>
            <span class="s1">bps_tuple</span><span class="s2">,</span>
            <span class="s1">extra_tuple</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;format key: </span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">self.mode</span><span class="s2">, </span><span class="s1">rawmode = OPEN_INFO[key]</span>
        <span class="s2">except </span><span class="s1">KeyError </span><span class="s2">as </span><span class="s1">e:</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;- unsupported format&quot;</span><span class="s1">)</span>
            <span class="s1">msg = </span><span class="s5">&quot;unknown pixel mode&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg) </span><span class="s2">from </span><span class="s1">e</span>

        <span class="s1">logger.debug(</span><span class="s5">f&quot;- raw mode: </span><span class="s2">{</span><span class="s1">rawmode</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">f&quot;- pil mode: </span><span class="s2">{</span><span class="s1">self.mode</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>

        <span class="s1">self.info[</span><span class="s5">&quot;compression&quot;</span><span class="s1">] = self._compression</span>

        <span class="s1">xres = self.tag_v2.get(X_RESOLUTION</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">yres = self.tag_v2.get(Y_RESOLUTION</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s2">if </span><span class="s1">xres </span><span class="s2">and </span><span class="s1">yres:</span>
            <span class="s1">resunit = self.tag_v2.get(RESOLUTION_UNIT)</span>
            <span class="s2">if </span><span class="s1">resunit == </span><span class="s3">2</span><span class="s1">:  </span><span class="s0"># dots per inch</span>
                <span class="s1">self.info[</span><span class="s5">&quot;dpi&quot;</span><span class="s1">] = (xres</span><span class="s2">, </span><span class="s1">yres)</span>
            <span class="s2">elif </span><span class="s1">resunit == </span><span class="s3">3</span><span class="s1">:  </span><span class="s0"># dots per centimeter. convert to dpi</span>
                <span class="s1">self.info[</span><span class="s5">&quot;dpi&quot;</span><span class="s1">] = (xres * </span><span class="s3">2.54</span><span class="s2">, </span><span class="s1">yres * </span><span class="s3">2.54</span><span class="s1">)</span>
            <span class="s2">elif </span><span class="s1">resunit </span><span class="s2">is None</span><span class="s1">:  </span><span class="s0"># used to default to 1, but now 2)</span>
                <span class="s1">self.info[</span><span class="s5">&quot;dpi&quot;</span><span class="s1">] = (xres</span><span class="s2">, </span><span class="s1">yres)</span>
                <span class="s0"># For backward compatibility,</span>
                <span class="s0"># we also preserve the old behavior</span>
                <span class="s1">self.info[</span><span class="s5">&quot;resolution&quot;</span><span class="s1">] = xres</span><span class="s2">, </span><span class="s1">yres</span>
            <span class="s2">else</span><span class="s1">:  </span><span class="s0"># No absolute unit of measurement</span>
                <span class="s1">self.info[</span><span class="s5">&quot;resolution&quot;</span><span class="s1">] = xres</span><span class="s2">, </span><span class="s1">yres</span>

        <span class="s0"># build tile descriptors</span>
        <span class="s1">x = y = layer = </span><span class="s3">0</span>
        <span class="s1">self.tile = []</span>
        <span class="s1">self.use_load_libtiff = READ_LIBTIFF </span><span class="s2">or </span><span class="s1">self._compression != </span><span class="s5">&quot;raw&quot;</span>
        <span class="s2">if </span><span class="s1">self.use_load_libtiff:</span>
            <span class="s0"># Decoder expects entire file as one tile.</span>
            <span class="s0"># There's a buffer size limit in load (64k)</span>
            <span class="s0"># so large g4 images will fail if we use that</span>
            <span class="s0"># function.</span>
            <span class="s0">#</span>
            <span class="s0"># Setup the one tile for the whole image, then</span>
            <span class="s0"># use the _load_libtiff function.</span>

            <span class="s0"># libtiff handles the fillmode for us, so 1;IR should</span>
            <span class="s0"># actually be 1;I. Including the R double reverses the</span>
            <span class="s0"># bits, so stripes of the image are reversed.  See</span>
            <span class="s0"># https://github.com/python-pillow/Pillow/issues/279</span>
            <span class="s2">if </span><span class="s1">fillorder == </span><span class="s3">2</span><span class="s1">:</span>
                <span class="s0"># Replace fillorder with fillorder=1</span>
                <span class="s1">key = key[:</span><span class="s3">3</span><span class="s1">] + (</span><span class="s3">1</span><span class="s2">,</span><span class="s1">) + key[</span><span class="s3">4</span><span class="s1">:]</span>
                <span class="s1">logger.debug(</span><span class="s5">f&quot;format key: </span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s1">)</span>
                <span class="s0"># this should always work, since all the</span>
                <span class="s0"># fillorder==2 modes have a corresponding</span>
                <span class="s0"># fillorder=1 mode</span>
                <span class="s1">self.mode</span><span class="s2">, </span><span class="s1">rawmode = OPEN_INFO[key]</span>
            <span class="s0"># libtiff always returns the bytes in native order.</span>
            <span class="s0"># we're expecting image byte order. So, if the rawmode</span>
            <span class="s0"># contains I;16, we need to convert from native to image</span>
            <span class="s0"># byte order.</span>
            <span class="s2">if </span><span class="s1">rawmode == </span><span class="s5">&quot;I;16&quot;</span><span class="s1">:</span>
                <span class="s1">rawmode = </span><span class="s5">&quot;I;16N&quot;</span>
            <span class="s2">if </span><span class="s5">&quot;;16B&quot; </span><span class="s2">in </span><span class="s1">rawmode:</span>
                <span class="s1">rawmode = rawmode.replace(</span><span class="s5">&quot;;16B&quot;</span><span class="s2">, </span><span class="s5">&quot;;16N&quot;</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s5">&quot;;16L&quot; </span><span class="s2">in </span><span class="s1">rawmode:</span>
                <span class="s1">rawmode = rawmode.replace(</span><span class="s5">&quot;;16L&quot;</span><span class="s2">, </span><span class="s5">&quot;;16N&quot;</span><span class="s1">)</span>

            <span class="s0"># YCbCr images with new jpeg compression with pixels in one plane</span>
            <span class="s0"># unpacked straight into RGB values</span>
            <span class="s2">if </span><span class="s1">(</span>
                <span class="s1">photo == </span><span class="s3">6</span>
                <span class="s2">and </span><span class="s1">self._compression == </span><span class="s5">&quot;jpeg&quot;</span>
                <span class="s2">and </span><span class="s1">self._planar_configuration == </span><span class="s3">1</span>
            <span class="s1">):</span>
                <span class="s1">rawmode = </span><span class="s5">&quot;RGB&quot;</span>

            <span class="s0"># Offset in the tile tuple is 0, we go from 0,0 to</span>
            <span class="s0"># w,h, and we only do this once -- eds</span>
            <span class="s1">a = (rawmode</span><span class="s2">, </span><span class="s1">self._compression</span><span class="s2">, False, </span><span class="s1">self.tag_v2.offset)</span>
            <span class="s1">self.tile.append((</span><span class="s5">&quot;libtiff&quot;</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">xsize</span><span class="s2">, </span><span class="s1">ysize)</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">a))</span>

        <span class="s2">elif </span><span class="s1">STRIPOFFSETS </span><span class="s2">in </span><span class="s1">self.tag_v2 </span><span class="s2">or </span><span class="s1">TILEOFFSETS </span><span class="s2">in </span><span class="s1">self.tag_v2:</span>
            <span class="s0"># striped image</span>
            <span class="s2">if </span><span class="s1">STRIPOFFSETS </span><span class="s2">in </span><span class="s1">self.tag_v2:</span>
                <span class="s1">offsets = self.tag_v2[STRIPOFFSETS]</span>
                <span class="s1">h = self.tag_v2.get(ROWSPERSTRIP</span><span class="s2">, </span><span class="s1">ysize)</span>
                <span class="s1">w = self.size[</span><span class="s3">0</span><span class="s1">]</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s0"># tiled image</span>
                <span class="s1">offsets = self.tag_v2[TILEOFFSETS]</span>
                <span class="s1">w = self.tag_v2.get(TILEWIDTH)</span>
                <span class="s1">h = self.tag_v2.get(TILELENGTH)</span>

            <span class="s2">for </span><span class="s1">offset </span><span class="s2">in </span><span class="s1">offsets:</span>
                <span class="s2">if </span><span class="s1">x + w &gt; xsize:</span>
                    <span class="s1">stride = w * sum(bps_tuple) / </span><span class="s3">8  </span><span class="s0"># bytes per line</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">stride = </span><span class="s3">0</span>

                <span class="s1">tile_rawmode = rawmode</span>
                <span class="s2">if </span><span class="s1">self._planar_configuration == </span><span class="s3">2</span><span class="s1">:</span>
                    <span class="s0"># each band on it's own layer</span>
                    <span class="s1">tile_rawmode = rawmode[layer]</span>
                    <span class="s0"># adjust stride width accordingly</span>
                    <span class="s1">stride /= bps_count</span>

                <span class="s1">a = (tile_rawmode</span><span class="s2">, </span><span class="s1">int(stride)</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
                <span class="s1">self.tile.append(</span>
                    <span class="s1">(</span>
                        <span class="s1">self._compression</span><span class="s2">,</span>
                        <span class="s1">(x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">min(x + w</span><span class="s2">, </span><span class="s1">xsize)</span><span class="s2">, </span><span class="s1">min(y + h</span><span class="s2">, </span><span class="s1">ysize))</span><span class="s2">,</span>
                        <span class="s1">offset</span><span class="s2">,</span>
                        <span class="s1">a</span><span class="s2">,</span>
                    <span class="s1">)</span>
                <span class="s1">)</span>
                <span class="s1">x = x + w</span>
                <span class="s2">if </span><span class="s1">x &gt;= self.size[</span><span class="s3">0</span><span class="s1">]:</span>
                    <span class="s1">x</span><span class="s2">, </span><span class="s1">y = </span><span class="s3">0</span><span class="s2">, </span><span class="s1">y + h</span>
                    <span class="s2">if </span><span class="s1">y &gt;= self.size[</span><span class="s3">1</span><span class="s1">]:</span>
                        <span class="s1">x = y = </span><span class="s3">0</span>
                        <span class="s1">layer += </span><span class="s3">1</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">logger.debug(</span><span class="s5">&quot;- unsupported data organization&quot;</span><span class="s1">)</span>
            <span class="s1">msg = </span><span class="s5">&quot;unknown data organization&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError(msg)</span>

        <span class="s0"># Fix up info.</span>
        <span class="s2">if </span><span class="s1">ICCPROFILE </span><span class="s2">in </span><span class="s1">self.tag_v2:</span>
            <span class="s1">self.info[</span><span class="s5">&quot;icc_profile&quot;</span><span class="s1">] = self.tag_v2[ICCPROFILE]</span>

        <span class="s0"># fixup palette descriptor</span>

        <span class="s2">if </span><span class="s1">self.mode </span><span class="s2">in </span><span class="s1">[</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;PA&quot;</span><span class="s1">]:</span>
            <span class="s1">palette = [o8(b // </span><span class="s3">256</span><span class="s1">) </span><span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">self.tag_v2[COLORMAP]]</span>
            <span class="s1">self.palette = ImagePalette.raw(</span><span class="s5">&quot;RGB;L&quot;</span><span class="s2">, </span><span class="s4">b&quot;&quot;</span><span class="s1">.join(palette))</span>

        <span class="s1">self._tile_orientation = self.tag_v2.get(</span><span class="s3">0x0112</span><span class="s1">)</span>


<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Write TIFF files</span>

<span class="s0"># little endian is default except for image modes with</span>
<span class="s0"># explicit big endian byte-order</span>

<span class="s1">SAVE_INFO = {</span>
    <span class="s0"># mode =&gt; rawmode, byteorder, photometrics,</span>
    <span class="s0">#           sampleformat, bitspersample, extra</span>
    <span class="s5">&quot;1&quot;</span><span class="s1">: (</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;L&quot;</span><span class="s1">: (</span><span class="s5">&quot;L&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;LA&quot;</span><span class="s1">: (</span><span class="s5">&quot;LA&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;P&quot;</span><span class="s1">: (</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;PA&quot;</span><span class="s1">: (</span><span class="s5">&quot;PA&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;32S&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I;16&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;16&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I;16S&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;16S&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;F&quot;</span><span class="s1">: (</span><span class="s5">&quot;F;32F&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;RGB&quot;</span><span class="s1">: (</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;RGBX&quot;</span><span class="s1">: (</span><span class="s5">&quot;RGBX&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;RGBA&quot;</span><span class="s1">: (</span><span class="s5">&quot;RGBA&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;CMYK&quot;</span><span class="s1">: (</span><span class="s5">&quot;CMYK&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;YCbCr&quot;</span><span class="s1">: (</span><span class="s5">&quot;YCbCr&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;LAB&quot;</span><span class="s1">: (</span><span class="s5">&quot;LAB&quot;</span><span class="s2">, </span><span class="s1">II</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I;32BS&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;32BS&quot;</span><span class="s2">, </span><span class="s1">MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I;16B&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;16B&quot;</span><span class="s2">, </span><span class="s1">MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;I;16BS&quot;</span><span class="s1">: (</span><span class="s5">&quot;I;16BS&quot;</span><span class="s2">, </span><span class="s1">MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">(</span><span class="s3">16</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s5">&quot;F;32BF&quot;</span><span class="s1">: (</span><span class="s5">&quot;F;32BF&quot;</span><span class="s2">, </span><span class="s1">MM</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">(</span><span class="s3">32</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
<span class="s1">}</span>


<span class="s2">def </span><span class="s1">_save(im</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">filename):</span>

    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">rawmode</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">, </span><span class="s1">photo</span><span class="s2">, </span><span class="s1">format</span><span class="s2">, </span><span class="s1">bits</span><span class="s2">, </span><span class="s1">extra = SAVE_INFO[im.mode]</span>
    <span class="s2">except </span><span class="s1">KeyError </span><span class="s2">as </span><span class="s1">e:</span>
        <span class="s1">msg = </span><span class="s5">f&quot;cannot write mode </span><span class="s2">{</span><span class="s1">im.mode</span><span class="s2">} </span><span class="s5">as TIFF&quot;</span>
        <span class="s2">raise </span><span class="s1">OSError(msg) </span><span class="s2">from </span><span class="s1">e</span>

    <span class="s1">ifd = ImageFileDirectory_v2(prefix=prefix)</span>

    <span class="s1">encoderinfo = im.encoderinfo</span>
    <span class="s1">encoderconfig = im.encoderconfig</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">compression = encoderinfo[</span><span class="s5">&quot;compression&quot;</span><span class="s1">]</span>
    <span class="s2">except </span><span class="s1">KeyError:</span>
        <span class="s1">compression = im.info.get(</span><span class="s5">&quot;compression&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">isinstance(compression</span><span class="s2">, </span><span class="s1">int):</span>
            <span class="s0"># compression value may be from BMP. Ignore it</span>
            <span class="s1">compression = </span><span class="s2">None</span>
    <span class="s2">if </span><span class="s1">compression </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s1">compression = </span><span class="s5">&quot;raw&quot;</span>
    <span class="s2">elif </span><span class="s1">compression == </span><span class="s5">&quot;tiff_jpeg&quot;</span><span class="s1">:</span>
        <span class="s0"># OJPEG is obsolete, so use new-style JPEG compression instead</span>
        <span class="s1">compression = </span><span class="s5">&quot;jpeg&quot;</span>
    <span class="s2">elif </span><span class="s1">compression == </span><span class="s5">&quot;tiff_deflate&quot;</span><span class="s1">:</span>
        <span class="s1">compression = </span><span class="s5">&quot;tiff_adobe_deflate&quot;</span>

    <span class="s1">libtiff = WRITE_LIBTIFF </span><span class="s2">or </span><span class="s1">compression != </span><span class="s5">&quot;raw&quot;</span>

    <span class="s0"># required for color libtiff images</span>
    <span class="s1">ifd[PLANAR_CONFIGURATION] = </span><span class="s3">1</span>

    <span class="s1">ifd[IMAGEWIDTH] = im.size[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">ifd[IMAGELENGTH] = im.size[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s0"># write any arbitrary tags passed in as an ImageFileDirectory</span>
    <span class="s2">if </span><span class="s5">&quot;tiffinfo&quot; </span><span class="s2">in </span><span class="s1">encoderinfo:</span>
        <span class="s1">info = encoderinfo[</span><span class="s5">&quot;tiffinfo&quot;</span><span class="s1">]</span>
    <span class="s2">elif </span><span class="s5">&quot;exif&quot; </span><span class="s2">in </span><span class="s1">encoderinfo:</span>
        <span class="s1">info = encoderinfo[</span><span class="s5">&quot;exif&quot;</span><span class="s1">]</span>
        <span class="s2">if </span><span class="s1">isinstance(info</span><span class="s2">, </span><span class="s1">bytes):</span>
            <span class="s1">exif = Image.Exif()</span>
            <span class="s1">exif.load(info)</span>
            <span class="s1">info = exif</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">info = {}</span>
    <span class="s1">logger.debug(</span><span class="s5">&quot;Tiffinfo Keys: %s&quot; </span><span class="s1">% list(info))</span>
    <span class="s2">if </span><span class="s1">isinstance(info</span><span class="s2">, </span><span class="s1">ImageFileDirectory_v1):</span>
        <span class="s1">info = info.to_v2()</span>
    <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">info:</span>
        <span class="s2">if </span><span class="s1">isinstance(info</span><span class="s2">, </span><span class="s1">Image.Exif) </span><span class="s2">and </span><span class="s1">key </span><span class="s2">in </span><span class="s1">TiffTags.TAGS_V2_GROUPS.keys():</span>
            <span class="s1">ifd[key] = info.get_ifd(key)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">ifd[key] = info.get(key)</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">ifd.tagtype[key] = info.tagtype[key]</span>
        <span class="s2">except </span><span class="s1">Exception:</span>
            <span class="s2">pass  </span><span class="s0"># might not be an IFD. Might not have populated type</span>

    <span class="s0"># additions written by Greg Couch, gregc@cgl.ucsf.edu</span>
    <span class="s0"># inspired by image-sig posting from Kevin Cazabon, kcazabon@home.com</span>
    <span class="s2">if </span><span class="s1">hasattr(im</span><span class="s2">, </span><span class="s5">&quot;tag_v2&quot;</span><span class="s1">):</span>
        <span class="s0"># preserve tags from original TIFF image file</span>
        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">(</span>
            <span class="s1">RESOLUTION_UNIT</span><span class="s2">,</span>
            <span class="s1">X_RESOLUTION</span><span class="s2">,</span>
            <span class="s1">Y_RESOLUTION</span><span class="s2">,</span>
            <span class="s1">IPTC_NAA_CHUNK</span><span class="s2">,</span>
            <span class="s1">PHOTOSHOP_CHUNK</span><span class="s2">,</span>
            <span class="s1">XMP</span><span class="s2">,</span>
        <span class="s1">):</span>
            <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">im.tag_v2:</span>
                <span class="s1">ifd[key] = im.tag_v2[key]</span>
                <span class="s1">ifd.tagtype[key] = im.tag_v2.tagtype[key]</span>

    <span class="s0"># preserve ICC profile (should also work when saving other formats</span>
    <span class="s0"># which support profiles as TIFF) -- 2008-06-06 Florian Hoech</span>
    <span class="s1">icc = encoderinfo.get(</span><span class="s5">&quot;icc_profile&quot;</span><span class="s2">, </span><span class="s1">im.info.get(</span><span class="s5">&quot;icc_profile&quot;</span><span class="s1">))</span>
    <span class="s2">if </span><span class="s1">icc:</span>
        <span class="s1">ifd[ICCPROFILE] = icc</span>

    <span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">name </span><span class="s2">in </span><span class="s1">[</span>
        <span class="s1">(IMAGEDESCRIPTION</span><span class="s2">, </span><span class="s5">&quot;description&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(X_RESOLUTION</span><span class="s2">, </span><span class="s5">&quot;resolution&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(Y_RESOLUTION</span><span class="s2">, </span><span class="s5">&quot;resolution&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(X_RESOLUTION</span><span class="s2">, </span><span class="s5">&quot;x_resolution&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(Y_RESOLUTION</span><span class="s2">, </span><span class="s5">&quot;y_resolution&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(RESOLUTION_UNIT</span><span class="s2">, </span><span class="s5">&quot;resolution_unit&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(SOFTWARE</span><span class="s2">, </span><span class="s5">&quot;software&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(DATE_TIME</span><span class="s2">, </span><span class="s5">&quot;date_time&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(ARTIST</span><span class="s2">, </span><span class="s5">&quot;artist&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(COPYRIGHT</span><span class="s2">, </span><span class="s5">&quot;copyright&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]:</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">encoderinfo:</span>
            <span class="s1">ifd[key] = encoderinfo[name]</span>

    <span class="s1">dpi = encoderinfo.get(</span><span class="s5">&quot;dpi&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">dpi:</span>
        <span class="s1">ifd[RESOLUTION_UNIT] = </span><span class="s3">2</span>
        <span class="s1">ifd[X_RESOLUTION] = dpi[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">ifd[Y_RESOLUTION] = dpi[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s2">if </span><span class="s1">bits != (</span><span class="s3">1</span><span class="s2">,</span><span class="s1">):</span>
        <span class="s1">ifd[BITSPERSAMPLE] = bits</span>
        <span class="s2">if </span><span class="s1">len(bits) != </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">ifd[SAMPLESPERPIXEL] = len(bits)</span>
    <span class="s2">if </span><span class="s1">extra </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s1">ifd[EXTRASAMPLES] = extra</span>
    <span class="s2">if </span><span class="s1">format != </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s1">ifd[SAMPLEFORMAT] = format</span>

    <span class="s2">if </span><span class="s1">PHOTOMETRIC_INTERPRETATION </span><span class="s2">not in </span><span class="s1">ifd:</span>
        <span class="s1">ifd[PHOTOMETRIC_INTERPRETATION] = photo</span>
    <span class="s2">elif </span><span class="s1">im.mode </span><span class="s2">in </span><span class="s1">(</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;L&quot;</span><span class="s1">) </span><span class="s2">and </span><span class="s1">ifd[PHOTOMETRIC_INTERPRETATION] == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s2">if </span><span class="s1">im.mode == </span><span class="s5">&quot;1&quot;</span><span class="s1">:</span>
            <span class="s1">inverted_im = im.copy()</span>
            <span class="s1">px = inverted_im.load()</span>
            <span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">range(inverted_im.height):</span>
                <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">range(inverted_im.width):</span>
                    <span class="s1">px[x</span><span class="s2">, </span><span class="s1">y] = </span><span class="s3">0 </span><span class="s2">if </span><span class="s1">px[x</span><span class="s2">, </span><span class="s1">y] == </span><span class="s3">255 </span><span class="s2">else </span><span class="s3">255</span>
            <span class="s1">im = inverted_im</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">im = ImageOps.invert(im)</span>

    <span class="s2">if </span><span class="s1">im.mode </span><span class="s2">in </span><span class="s1">[</span><span class="s5">&quot;P&quot;</span><span class="s2">, </span><span class="s5">&quot;PA&quot;</span><span class="s1">]:</span>
        <span class="s1">lut = im.im.getpalette(</span><span class="s5">&quot;RGB&quot;</span><span class="s2">, </span><span class="s5">&quot;RGB;L&quot;</span><span class="s1">)</span>
        <span class="s1">colormap = []</span>
        <span class="s1">colors = len(lut) // </span><span class="s3">3</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">colormap += [v * </span><span class="s3">256 </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s1">lut[colors * i : colors * (i + </span><span class="s3">1</span><span class="s1">)]]</span>
            <span class="s1">colormap += [</span><span class="s3">0</span><span class="s1">] * (</span><span class="s3">256 </span><span class="s1">- colors)</span>
        <span class="s1">ifd[COLORMAP] = colormap</span>
    <span class="s0"># data orientation</span>
    <span class="s1">stride = len(bits) * ((im.size[</span><span class="s3">0</span><span class="s1">] * bits[</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">7</span><span class="s1">) // </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s0"># aim for given strip size (64 KB by default) when using libtiff writer</span>
    <span class="s2">if </span><span class="s1">libtiff:</span>
        <span class="s1">im_strip_size = encoderinfo.get(</span><span class="s5">&quot;strip_size&quot;</span><span class="s2">, </span><span class="s1">STRIP_SIZE)</span>
        <span class="s1">rows_per_strip = </span><span class="s3">1 </span><span class="s2">if </span><span class="s1">stride == </span><span class="s3">0 </span><span class="s2">else </span><span class="s1">min(im_strip_size // stride</span><span class="s2">, </span><span class="s1">im.size[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s0"># JPEG encoder expects multiple of 8 rows</span>
        <span class="s2">if </span><span class="s1">compression == </span><span class="s5">&quot;jpeg&quot;</span><span class="s1">:</span>
            <span class="s1">rows_per_strip = min(((rows_per_strip + </span><span class="s3">7</span><span class="s1">) // </span><span class="s3">8</span><span class="s1">) * </span><span class="s3">8</span><span class="s2">, </span><span class="s1">im.size[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">rows_per_strip = im.size[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">rows_per_strip == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s1">rows_per_strip = </span><span class="s3">1</span>
    <span class="s1">strip_byte_counts = </span><span class="s3">1 </span><span class="s2">if </span><span class="s1">stride == </span><span class="s3">0 </span><span class="s2">else </span><span class="s1">stride * rows_per_strip</span>
    <span class="s1">strips_per_image = (im.size[</span><span class="s3">1</span><span class="s1">] + rows_per_strip - </span><span class="s3">1</span><span class="s1">) // rows_per_strip</span>
    <span class="s1">ifd[ROWSPERSTRIP] = rows_per_strip</span>
    <span class="s2">if </span><span class="s1">strip_byte_counts &gt;= </span><span class="s3">2</span><span class="s1">**</span><span class="s3">16</span><span class="s1">:</span>
        <span class="s1">ifd.tagtype[STRIPBYTECOUNTS] = TiffTags.LONG</span>
    <span class="s1">ifd[STRIPBYTECOUNTS] = (strip_byte_counts</span><span class="s2">,</span><span class="s1">) * (strips_per_image - </span><span class="s3">1</span><span class="s1">) + (</span>
        <span class="s1">stride * im.size[</span><span class="s3">1</span><span class="s1">] - strip_byte_counts * (strips_per_image - </span><span class="s3">1</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">ifd[STRIPOFFSETS] = tuple(</span>
        <span class="s1">range(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">strip_byte_counts * strips_per_image</span><span class="s2">, </span><span class="s1">strip_byte_counts)</span>
    <span class="s1">)  </span><span class="s0"># this is adjusted by IFD writer</span>
    <span class="s0"># no compression by default:</span>
    <span class="s1">ifd[COMPRESSION] = COMPRESSION_INFO_REV.get(compression</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s2">if </span><span class="s1">im.mode == </span><span class="s5">&quot;YCbCr&quot;</span><span class="s1">:</span>
        <span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">{</span>
            <span class="s1">YCBCRSUBSAMPLING: (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">REFERENCEBLACKWHITE: (</span><span class="s3">0</span><span class="s2">, </span><span class="s3">255</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">255</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">255</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}.items():</span>
            <span class="s1">ifd.setdefault(tag</span><span class="s2">, </span><span class="s1">value)</span>

    <span class="s1">blocklist = [TILEWIDTH</span><span class="s2">, </span><span class="s1">TILELENGTH</span><span class="s2">, </span><span class="s1">TILEOFFSETS</span><span class="s2">, </span><span class="s1">TILEBYTECOUNTS]</span>
    <span class="s2">if </span><span class="s1">libtiff:</span>
        <span class="s2">if </span><span class="s5">&quot;quality&quot; </span><span class="s2">in </span><span class="s1">encoderinfo:</span>
            <span class="s1">quality = encoderinfo[</span><span class="s5">&quot;quality&quot;</span><span class="s1">]</span>
            <span class="s2">if not </span><span class="s1">isinstance(quality</span><span class="s2">, </span><span class="s1">int) </span><span class="s2">or </span><span class="s1">quality &lt; </span><span class="s3">0 </span><span class="s2">or </span><span class="s1">quality &gt; </span><span class="s3">100</span><span class="s1">:</span>
                <span class="s1">msg = </span><span class="s5">&quot;Invalid quality setting&quot;</span>
                <span class="s2">raise </span><span class="s1">ValueError(msg)</span>
            <span class="s2">if </span><span class="s1">compression != </span><span class="s5">&quot;jpeg&quot;</span><span class="s1">:</span>
                <span class="s1">msg = </span><span class="s5">&quot;quality setting only supported for 'jpeg' compression&quot;</span>
                <span class="s2">raise </span><span class="s1">ValueError(msg)</span>
            <span class="s1">ifd[JPEGQUALITY] = quality</span>

        <span class="s1">logger.debug(</span><span class="s5">&quot;Saving using libtiff encoder&quot;</span><span class="s1">)</span>
        <span class="s1">logger.debug(</span><span class="s5">&quot;Items: %s&quot; </span><span class="s1">% sorted(ifd.items()))</span>
        <span class="s1">_fp = </span><span class="s3">0</span>
        <span class="s2">if </span><span class="s1">hasattr(fp</span><span class="s2">, </span><span class="s5">&quot;fileno&quot;</span><span class="s1">):</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">fp.seek(</span><span class="s3">0</span><span class="s1">)</span>
                <span class="s1">_fp = os.dup(fp.fileno())</span>
            <span class="s2">except </span><span class="s1">io.UnsupportedOperation:</span>
                <span class="s2">pass</span>

        <span class="s0"># optional types for non core tags</span>
        <span class="s1">types = {}</span>
        <span class="s0"># STRIPOFFSETS and STRIPBYTECOUNTS are added by the library</span>
        <span class="s0"># based on the data in the strip.</span>
        <span class="s0"># The other tags expect arrays with a certain length (fixed or depending on</span>
        <span class="s0"># BITSPERSAMPLE, etc), passing arrays with a different length will result in</span>
        <span class="s0"># segfaults. Block these tags until we add extra validation.</span>
        <span class="s0"># SUBIFD may also cause a segfault.</span>
        <span class="s1">blocklist += [</span>
            <span class="s1">REFERENCEBLACKWHITE</span><span class="s2">,</span>
            <span class="s1">STRIPBYTECOUNTS</span><span class="s2">,</span>
            <span class="s1">STRIPOFFSETS</span><span class="s2">,</span>
            <span class="s1">TRANSFERFUNCTION</span><span class="s2">,</span>
            <span class="s1">SUBIFD</span><span class="s2">,</span>
        <span class="s1">]</span>

        <span class="s0"># bits per sample is a single short in the tiff directory, not a list.</span>
        <span class="s1">atts = {BITSPERSAMPLE: bits[</span><span class="s3">0</span><span class="s1">]}</span>
        <span class="s0"># Merge the ones that we have with (optional) more bits from</span>
        <span class="s0"># the original file, e.g x,y resolution so that we can</span>
        <span class="s0"># save(load('')) == original file.</span>
        <span class="s1">legacy_ifd = {}</span>
        <span class="s2">if </span><span class="s1">hasattr(im</span><span class="s2">, </span><span class="s5">&quot;tag&quot;</span><span class="s1">):</span>
            <span class="s1">legacy_ifd = im.tag.to_v2()</span>

        <span class="s0"># SAMPLEFORMAT is determined by the image format and should not be copied</span>
        <span class="s0"># from legacy_ifd.</span>
        <span class="s1">supplied_tags = {**getattr(im</span><span class="s2">, </span><span class="s5">&quot;tag_v2&quot;</span><span class="s2">, </span><span class="s1">{})</span><span class="s2">, </span><span class="s1">**legacy_ifd}</span>
        <span class="s2">if </span><span class="s1">SAMPLEFORMAT </span><span class="s2">in </span><span class="s1">supplied_tags:</span>
            <span class="s2">del </span><span class="s1">supplied_tags[SAMPLEFORMAT]</span>

        <span class="s2">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">itertools.chain(ifd.items()</span><span class="s2">, </span><span class="s1">supplied_tags.items()):</span>
            <span class="s0"># Libtiff can only process certain core items without adding</span>
            <span class="s0"># them to the custom dictionary.</span>
            <span class="s0"># Custom items are supported for int, float, unicode, string and byte</span>
            <span class="s0"># values. Other types and tuples require a tagtype.</span>
            <span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">TiffTags.LIBTIFF_CORE:</span>
                <span class="s2">if not </span><span class="s1">Image.core.libtiff_support_custom_tags:</span>
                    <span class="s2">continue</span>

                <span class="s2">if </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">ifd.tagtype:</span>
                    <span class="s1">types[tag] = ifd.tagtype[tag]</span>
                <span class="s2">elif not </span><span class="s1">(isinstance(value</span><span class="s2">, </span><span class="s1">(int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">str</span><span class="s2">, </span><span class="s1">bytes))):</span>
                    <span class="s2">continue</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">type = TiffTags.lookup(tag).type</span>
                    <span class="s2">if </span><span class="s1">type:</span>
                        <span class="s1">types[tag] = type</span>
            <span class="s2">if </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">atts </span><span class="s2">and </span><span class="s1">tag </span><span class="s2">not in </span><span class="s1">blocklist:</span>
                <span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">str):</span>
                    <span class="s1">atts[tag] = value.encode(</span><span class="s5">&quot;ascii&quot;</span><span class="s2">, </span><span class="s5">&quot;replace&quot;</span><span class="s1">) + </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span>
                <span class="s2">elif </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">IFDRational):</span>
                    <span class="s1">atts[tag] = float(value)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">atts[tag] = value</span>

        <span class="s2">if </span><span class="s1">SAMPLEFORMAT </span><span class="s2">in </span><span class="s1">atts </span><span class="s2">and </span><span class="s1">len(atts[SAMPLEFORMAT]) == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">atts[SAMPLEFORMAT] = atts[SAMPLEFORMAT][</span><span class="s3">0</span><span class="s1">]</span>

        <span class="s1">logger.debug(</span><span class="s5">&quot;Converted items: %s&quot; </span><span class="s1">% sorted(atts.items()))</span>

        <span class="s0"># libtiff always expects the bytes in native order.</span>
        <span class="s0"># we're storing image byte order. So, if the rawmode</span>
        <span class="s0"># contains I;16, we need to convert from native to image</span>
        <span class="s0"># byte order.</span>
        <span class="s2">if </span><span class="s1">im.mode </span><span class="s2">in </span><span class="s1">(</span><span class="s5">&quot;I;16B&quot;</span><span class="s2">, </span><span class="s5">&quot;I;16&quot;</span><span class="s1">):</span>
            <span class="s1">rawmode = </span><span class="s5">&quot;I;16N&quot;</span>

        <span class="s0"># Pass tags as sorted list so that the tags are set in a fixed order.</span>
        <span class="s0"># This is required by libtiff for some tags. For example, the JPEGQUALITY</span>
        <span class="s0"># pseudo tag requires that the COMPRESS tag was already set.</span>
        <span class="s1">tags = list(atts.items())</span>
        <span class="s1">tags.sort()</span>
        <span class="s1">a = (rawmode</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">, </span><span class="s1">_fp</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">, </span><span class="s1">tags</span><span class="s2">, </span><span class="s1">types)</span>
        <span class="s1">e = Image._getencoder(im.mode</span><span class="s2">, </span><span class="s5">&quot;libtiff&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">encoderconfig)</span>
        <span class="s1">e.setimage(im.im</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">) + im.size)</span>
        <span class="s2">while True</span><span class="s1">:</span>
            <span class="s0"># undone, change to self.decodermaxblock:</span>
            <span class="s1">l</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">d = e.encode(</span><span class="s3">16 </span><span class="s1">* </span><span class="s3">1024</span><span class="s1">)</span>
            <span class="s2">if not </span><span class="s1">_fp:</span>
                <span class="s1">fp.write(d)</span>
            <span class="s2">if </span><span class="s1">s:</span>
                <span class="s2">break</span>
        <span class="s2">if </span><span class="s1">s &lt; </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;encoder error </span><span class="s2">{</span><span class="s1">s</span><span class="s2">} </span><span class="s5">when writing image file&quot;</span>
            <span class="s2">raise </span><span class="s1">OSError(msg)</span>

    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">for </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">blocklist:</span>
            <span class="s2">del </span><span class="s1">ifd[tag]</span>
        <span class="s1">offset = ifd.save(fp)</span>

        <span class="s1">ImageFile._save(</span>
            <span class="s1">im</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">[(</span><span class="s5">&quot;raw&quot;</span><span class="s2">, </span><span class="s1">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">) + im.size</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">(rawmode</span><span class="s2">, </span><span class="s1">stride</span><span class="s2">, </span><span class="s3">1</span><span class="s1">))]</span>
        <span class="s1">)</span>

    <span class="s0"># -- helper for multi-page save --</span>
    <span class="s2">if </span><span class="s5">&quot;_debug_multipage&quot; </span><span class="s2">in </span><span class="s1">encoderinfo:</span>
        <span class="s0"># just to access o32 and o16 (using correct byte order)</span>
        <span class="s1">im._debug_multipage = ifd</span>


<span class="s2">class </span><span class="s1">AppendingTiffWriter:</span>
    <span class="s1">fieldSizes = [</span>
        <span class="s3">0</span><span class="s2">,  </span><span class="s0"># None</span>
        <span class="s3">1</span><span class="s2">,  </span><span class="s0"># byte</span>
        <span class="s3">1</span><span class="s2">,  </span><span class="s0"># ascii</span>
        <span class="s3">2</span><span class="s2">,  </span><span class="s0"># short</span>
        <span class="s3">4</span><span class="s2">,  </span><span class="s0"># long</span>
        <span class="s3">8</span><span class="s2">,  </span><span class="s0"># rational</span>
        <span class="s3">1</span><span class="s2">,  </span><span class="s0"># sbyte</span>
        <span class="s3">1</span><span class="s2">,  </span><span class="s0"># undefined</span>
        <span class="s3">2</span><span class="s2">,  </span><span class="s0"># sshort</span>
        <span class="s3">4</span><span class="s2">,  </span><span class="s0"># slong</span>
        <span class="s3">8</span><span class="s2">,  </span><span class="s0"># srational</span>
        <span class="s3">4</span><span class="s2">,  </span><span class="s0"># float</span>
        <span class="s3">8</span><span class="s2">,  </span><span class="s0"># double</span>
    <span class="s1">]</span>

    <span class="s0">#    StripOffsets = 273</span>
    <span class="s0">#    FreeOffsets = 288</span>
    <span class="s0">#    TileOffsets = 324</span>
    <span class="s0">#    JPEGQTables = 519</span>
    <span class="s0">#    JPEGDCTables = 520</span>
    <span class="s0">#    JPEGACTables = 521</span>
    <span class="s1">Tags = {</span><span class="s3">273</span><span class="s2">, </span><span class="s3">288</span><span class="s2">, </span><span class="s3">324</span><span class="s2">, </span><span class="s3">519</span><span class="s2">, </span><span class="s3">520</span><span class="s2">, </span><span class="s3">521</span><span class="s1">}</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">fn</span><span class="s2">, </span><span class="s1">new=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s2">if </span><span class="s1">hasattr(fn</span><span class="s2">, </span><span class="s5">&quot;read&quot;</span><span class="s1">):</span>
            <span class="s1">self.f = fn</span>
            <span class="s1">self.close_fp = </span><span class="s2">False</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">self.name = fn</span>
            <span class="s1">self.close_fp = </span><span class="s2">True</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">self.f = open(fn</span><span class="s2">, </span><span class="s5">&quot;w+b&quot; </span><span class="s2">if </span><span class="s1">new </span><span class="s2">else </span><span class="s5">&quot;r+b&quot;</span><span class="s1">)</span>
            <span class="s2">except </span><span class="s1">OSError:</span>
                <span class="s1">self.f = open(fn</span><span class="s2">, </span><span class="s5">&quot;w+b&quot;</span><span class="s1">)</span>
        <span class="s1">self.beginning = self.f.tell()</span>
        <span class="s1">self.setup()</span>

    <span class="s2">def </span><span class="s1">setup(self):</span>
        <span class="s0"># Reset everything.</span>
        <span class="s1">self.f.seek(self.beginning</span><span class="s2">, </span><span class="s1">os.SEEK_SET)</span>

        <span class="s1">self.whereToWriteNewIFDOffset = </span><span class="s2">None</span>
        <span class="s1">self.offsetOfNewPage = </span><span class="s3">0</span>

        <span class="s1">self.IIMM = iimm = self.f.read(</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s2">if not </span><span class="s1">iimm:</span>
            <span class="s0"># empty file - first page</span>
            <span class="s1">self.isFirst = </span><span class="s2">True</span>
            <span class="s2">return</span>

        <span class="s1">self.isFirst = </span><span class="s2">False</span>
        <span class="s2">if </span><span class="s1">iimm == </span><span class="s4">b&quot;II</span><span class="s2">\x2a\x00</span><span class="s4">&quot;</span><span class="s1">:</span>
            <span class="s1">self.setEndian(</span><span class="s5">&quot;&lt;&quot;</span><span class="s1">)</span>
        <span class="s2">elif </span><span class="s1">iimm == </span><span class="s4">b&quot;MM</span><span class="s2">\x00\x2a</span><span class="s4">&quot;</span><span class="s1">:</span>
            <span class="s1">self.setEndian(</span><span class="s5">&quot;&gt;&quot;</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">&quot;Invalid TIFF file header&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

        <span class="s1">self.skipIFDs()</span>
        <span class="s1">self.goToEnd()</span>

    <span class="s2">def </span><span class="s1">finalize(self):</span>
        <span class="s2">if </span><span class="s1">self.isFirst:</span>
            <span class="s2">return</span>

        <span class="s0"># fix offsets</span>
        <span class="s1">self.f.seek(self.offsetOfNewPage)</span>

        <span class="s1">iimm = self.f.read(</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s2">if not </span><span class="s1">iimm:</span>
            <span class="s0"># msg = &quot;nothing written into new page&quot;</span>
            <span class="s0"># raise RuntimeError(msg)</span>
            <span class="s0"># Make it easy to finish a frame without committing to a new one.</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">iimm != self.IIMM:</span>
            <span class="s1">msg = </span><span class="s5">&quot;IIMM of new page doesn't match IIMM of first page&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

        <span class="s1">ifd_offset = self.readLong()</span>
        <span class="s1">ifd_offset += self.offsetOfNewPage</span>
        <span class="s1">self.f.seek(self.whereToWriteNewIFDOffset)</span>
        <span class="s1">self.writeLong(ifd_offset)</span>
        <span class="s1">self.f.seek(ifd_offset)</span>
        <span class="s1">self.fixIFD()</span>

    <span class="s2">def </span><span class="s1">newFrame(self):</span>
        <span class="s0"># Call this to finish a frame.</span>
        <span class="s1">self.finalize()</span>
        <span class="s1">self.setup()</span>

    <span class="s2">def </span><span class="s1">__enter__(self):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__(self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback):</span>
        <span class="s2">if </span><span class="s1">self.close_fp:</span>
            <span class="s1">self.close()</span>
        <span class="s2">return False</span>

    <span class="s2">def </span><span class="s1">tell(self):</span>
        <span class="s2">return </span><span class="s1">self.f.tell() - self.offsetOfNewPage</span>

    <span class="s2">def </span><span class="s1">seek(self</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">, </span><span class="s1">whence=io.SEEK_SET):</span>
        <span class="s2">if </span><span class="s1">whence == os.SEEK_SET:</span>
            <span class="s1">offset += self.offsetOfNewPage</span>

        <span class="s1">self.f.seek(offset</span><span class="s2">, </span><span class="s1">whence)</span>
        <span class="s2">return </span><span class="s1">self.tell()</span>

    <span class="s2">def </span><span class="s1">goToEnd(self):</span>
        <span class="s1">self.f.seek(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">os.SEEK_END)</span>
        <span class="s1">pos = self.f.tell()</span>

        <span class="s0"># pad to 16 byte boundary</span>
        <span class="s1">pad_bytes = </span><span class="s3">16 </span><span class="s1">- pos % </span><span class="s3">16</span>
        <span class="s2">if </span><span class="s3">0 </span><span class="s1">&lt; pad_bytes &lt; </span><span class="s3">16</span><span class="s1">:</span>
            <span class="s1">self.f.write(bytes(pad_bytes))</span>
        <span class="s1">self.offsetOfNewPage = self.f.tell()</span>

    <span class="s2">def </span><span class="s1">setEndian(self</span><span class="s2">, </span><span class="s1">endian):</span>
        <span class="s1">self.endian = endian</span>
        <span class="s1">self.longFmt = self.endian + </span><span class="s5">&quot;L&quot;</span>
        <span class="s1">self.shortFmt = self.endian + </span><span class="s5">&quot;H&quot;</span>
        <span class="s1">self.tagFormat = self.endian + </span><span class="s5">&quot;HHL&quot;</span>

    <span class="s2">def </span><span class="s1">skipIFDs(self):</span>
        <span class="s2">while True</span><span class="s1">:</span>
            <span class="s1">ifd_offset = self.readLong()</span>
            <span class="s2">if </span><span class="s1">ifd_offset == </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s1">self.whereToWriteNewIFDOffset = self.f.tell() - </span><span class="s3">4</span>
                <span class="s2">break</span>

            <span class="s1">self.f.seek(ifd_offset)</span>
            <span class="s1">num_tags = self.readShort()</span>
            <span class="s1">self.f.seek(num_tags * </span><span class="s3">12</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>

    <span class="s2">def </span><span class="s1">write(self</span><span class="s2">, </span><span class="s1">data):</span>
        <span class="s2">return </span><span class="s1">self.f.write(data)</span>

    <span class="s2">def </span><span class="s1">readShort(self):</span>
        <span class="s1">(value</span><span class="s2">,</span><span class="s1">) = struct.unpack(self.shortFmt</span><span class="s2">, </span><span class="s1">self.f.read(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s2">return </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">readLong(self):</span>
        <span class="s1">(value</span><span class="s2">,</span><span class="s1">) = struct.unpack(self.longFmt</span><span class="s2">, </span><span class="s1">self.f.read(</span><span class="s3">4</span><span class="s1">))</span>
        <span class="s2">return </span><span class="s1">value</span>

    <span class="s2">def </span><span class="s1">rewriteLastShortToLong(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">self.f.seek(-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>
        <span class="s1">bytes_written = self.f.write(struct.pack(self.longFmt</span><span class="s2">, </span><span class="s1">value))</span>
        <span class="s2">if </span><span class="s1">bytes_written </span><span class="s2">is not None and </span><span class="s1">bytes_written != </span><span class="s3">4</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;wrote only </span><span class="s2">{</span><span class="s1">bytes_written</span><span class="s2">} </span><span class="s5">bytes but wanted 4&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

    <span class="s2">def </span><span class="s1">rewriteLastShort(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">self.f.seek(-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>
        <span class="s1">bytes_written = self.f.write(struct.pack(self.shortFmt</span><span class="s2">, </span><span class="s1">value))</span>
        <span class="s2">if </span><span class="s1">bytes_written </span><span class="s2">is not None and </span><span class="s1">bytes_written != </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;wrote only </span><span class="s2">{</span><span class="s1">bytes_written</span><span class="s2">} </span><span class="s5">bytes but wanted 2&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

    <span class="s2">def </span><span class="s1">rewriteLastLong(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">self.f.seek(-</span><span class="s3">4</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>
        <span class="s1">bytes_written = self.f.write(struct.pack(self.longFmt</span><span class="s2">, </span><span class="s1">value))</span>
        <span class="s2">if </span><span class="s1">bytes_written </span><span class="s2">is not None and </span><span class="s1">bytes_written != </span><span class="s3">4</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;wrote only </span><span class="s2">{</span><span class="s1">bytes_written</span><span class="s2">} </span><span class="s5">bytes but wanted 4&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

    <span class="s2">def </span><span class="s1">writeShort(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">bytes_written = self.f.write(struct.pack(self.shortFmt</span><span class="s2">, </span><span class="s1">value))</span>
        <span class="s2">if </span><span class="s1">bytes_written </span><span class="s2">is not None and </span><span class="s1">bytes_written != </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;wrote only </span><span class="s2">{</span><span class="s1">bytes_written</span><span class="s2">} </span><span class="s5">bytes but wanted 2&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

    <span class="s2">def </span><span class="s1">writeLong(self</span><span class="s2">, </span><span class="s1">value):</span>
        <span class="s1">bytes_written = self.f.write(struct.pack(self.longFmt</span><span class="s2">, </span><span class="s1">value))</span>
        <span class="s2">if </span><span class="s1">bytes_written </span><span class="s2">is not None and </span><span class="s1">bytes_written != </span><span class="s3">4</span><span class="s1">:</span>
            <span class="s1">msg = </span><span class="s5">f&quot;wrote only </span><span class="s2">{</span><span class="s1">bytes_written</span><span class="s2">} </span><span class="s5">bytes but wanted 4&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

    <span class="s2">def </span><span class="s1">close(self):</span>
        <span class="s1">self.finalize()</span>
        <span class="s1">self.f.close()</span>

    <span class="s2">def </span><span class="s1">fixIFD(self):</span>
        <span class="s1">num_tags = self.readShort()</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(num_tags):</span>
            <span class="s1">tag</span><span class="s2">, </span><span class="s1">field_type</span><span class="s2">, </span><span class="s1">count = struct.unpack(self.tagFormat</span><span class="s2">, </span><span class="s1">self.f.read(</span><span class="s3">8</span><span class="s1">))</span>

            <span class="s1">field_size = self.fieldSizes[field_type]</span>
            <span class="s1">total_size = field_size * count</span>
            <span class="s1">is_local = total_size &lt;= </span><span class="s3">4</span>
            <span class="s2">if not </span><span class="s1">is_local:</span>
                <span class="s1">offset = self.readLong()</span>
                <span class="s1">offset += self.offsetOfNewPage</span>
                <span class="s1">self.rewriteLastLong(offset)</span>

            <span class="s2">if </span><span class="s1">tag </span><span class="s2">in </span><span class="s1">self.Tags:</span>
                <span class="s1">cur_pos = self.f.tell()</span>

                <span class="s2">if </span><span class="s1">is_local:</span>
                    <span class="s1">self.fixOffsets(</span>
                        <span class="s1">count</span><span class="s2">, </span><span class="s1">isShort=(field_size == </span><span class="s3">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">isLong=(field_size == </span><span class="s3">4</span><span class="s1">)</span>
                    <span class="s1">)</span>
                    <span class="s1">self.f.seek(cur_pos + </span><span class="s3">4</span><span class="s1">)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">self.f.seek(offset)</span>
                    <span class="s1">self.fixOffsets(</span>
                        <span class="s1">count</span><span class="s2">, </span><span class="s1">isShort=(field_size == </span><span class="s3">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">isLong=(field_size == </span><span class="s3">4</span><span class="s1">)</span>
                    <span class="s1">)</span>
                    <span class="s1">self.f.seek(cur_pos)</span>

                <span class="s1">offset = cur_pos = </span><span class="s2">None</span>

            <span class="s2">elif </span><span class="s1">is_local:</span>
                <span class="s0"># skip the locally stored value that is not an offset</span>
                <span class="s1">self.f.seek(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>

    <span class="s2">def </span><span class="s1">fixOffsets(self</span><span class="s2">, </span><span class="s1">count</span><span class="s2">, </span><span class="s1">isShort=</span><span class="s2">False, </span><span class="s1">isLong=</span><span class="s2">False</span><span class="s1">):</span>
        <span class="s2">if not </span><span class="s1">isShort </span><span class="s2">and not </span><span class="s1">isLong:</span>
            <span class="s1">msg = </span><span class="s5">&quot;offset is neither short nor long&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(msg)</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(count):</span>
            <span class="s1">offset = self.readShort() </span><span class="s2">if </span><span class="s1">isShort </span><span class="s2">else </span><span class="s1">self.readLong()</span>
            <span class="s1">offset += self.offsetOfNewPage</span>
            <span class="s2">if </span><span class="s1">isShort </span><span class="s2">and </span><span class="s1">offset &gt;= </span><span class="s3">65536</span><span class="s1">:</span>
                <span class="s0"># offset is now too large - we must convert shorts to longs</span>
                <span class="s2">if </span><span class="s1">count != </span><span class="s3">1</span><span class="s1">:</span>
                    <span class="s1">msg = </span><span class="s5">&quot;not implemented&quot;</span>
                    <span class="s2">raise </span><span class="s1">RuntimeError(msg)  </span><span class="s0"># XXX TODO</span>

                <span class="s0"># simple case - the offset is just one and therefore it is</span>
                <span class="s0"># local (not referenced with another offset)</span>
                <span class="s1">self.rewriteLastShortToLong(offset)</span>
                <span class="s1">self.f.seek(-</span><span class="s3">10</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>
                <span class="s1">self.writeShort(TiffTags.LONG)  </span><span class="s0"># rewrite the type to LONG</span>
                <span class="s1">self.f.seek(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">os.SEEK_CUR)</span>
            <span class="s2">elif </span><span class="s1">isShort:</span>
                <span class="s1">self.rewriteLastShort(offset)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">self.rewriteLastLong(offset)</span>


<span class="s2">def </span><span class="s1">_save_all(im</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">filename):</span>
    <span class="s1">encoderinfo = im.encoderinfo.copy()</span>
    <span class="s1">encoderconfig = im.encoderconfig</span>
    <span class="s1">append_images = list(encoderinfo.get(</span><span class="s5">&quot;append_images&quot;</span><span class="s2">, </span><span class="s1">[]))</span>
    <span class="s2">if not </span><span class="s1">hasattr(im</span><span class="s2">, </span><span class="s5">&quot;n_frames&quot;</span><span class="s1">) </span><span class="s2">and not </span><span class="s1">append_images:</span>
        <span class="s2">return </span><span class="s1">_save(im</span><span class="s2">, </span><span class="s1">fp</span><span class="s2">, </span><span class="s1">filename)</span>

    <span class="s1">cur_idx = im.tell()</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s2">with </span><span class="s1">AppendingTiffWriter(fp) </span><span class="s2">as </span><span class="s1">tf:</span>
            <span class="s2">for </span><span class="s1">ims </span><span class="s2">in </span><span class="s1">[im] + append_images:</span>
                <span class="s1">ims.encoderinfo = encoderinfo</span>
                <span class="s1">ims.encoderconfig = encoderconfig</span>
                <span class="s2">if not </span><span class="s1">hasattr(ims</span><span class="s2">, </span><span class="s5">&quot;n_frames&quot;</span><span class="s1">):</span>
                    <span class="s1">nfr = </span><span class="s3">1</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">nfr = ims.n_frames</span>

                <span class="s2">for </span><span class="s1">idx </span><span class="s2">in </span><span class="s1">range(nfr):</span>
                    <span class="s1">ims.seek(idx)</span>
                    <span class="s1">ims.load()</span>
                    <span class="s1">_save(ims</span><span class="s2">, </span><span class="s1">tf</span><span class="s2">, </span><span class="s1">filename)</span>
                    <span class="s1">tf.newFrame()</span>
    <span class="s2">finally</span><span class="s1">:</span>
        <span class="s1">im.seek(cur_idx)</span>


<span class="s0">#</span>
<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Register</span>

<span class="s1">Image.register_open(TiffImageFile.format</span><span class="s2">, </span><span class="s1">TiffImageFile</span><span class="s2">, </span><span class="s1">_accept)</span>
<span class="s1">Image.register_save(TiffImageFile.format</span><span class="s2">, </span><span class="s1">_save)</span>
<span class="s1">Image.register_save_all(TiffImageFile.format</span><span class="s2">, </span><span class="s1">_save_all)</span>

<span class="s1">Image.register_extensions(TiffImageFile.format</span><span class="s2">, </span><span class="s1">[</span><span class="s5">&quot;.tif&quot;</span><span class="s2">, </span><span class="s5">&quot;.tiff&quot;</span><span class="s1">])</span>

<span class="s1">Image.register_mime(TiffImageFile.format</span><span class="s2">, </span><span class="s5">&quot;image/tiff&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>